12cb1bd96237ca2c6ea71eac8fe90139
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createFolder = createFolder;
exports.getFolderById = getFolderById;
exports.getAllFolders = getAllFolders;
exports.getFolderTree = getFolderTree;
exports.getFolderTreePaginated = getFolderTreePaginated;
exports.getFolderTreeWithLazyLoading = getFolderTreeWithLazyLoading;
exports.updateFolder = updateFolder;
exports.deleteFolder = deleteFolder;
exports.getTestCasesInFolder = getTestCasesInFolder;
exports.addTestCaseToFolder = addTestCaseToFolder;
exports.removeTestCaseFromFolder = removeTestCaseFromFolder;
exports.moveTestCase = moveTestCase;
exports.moveTestCasesBatch = moveTestCasesBatch;
exports.checkCircularReference = checkCircularReference;
exports.reorderFolder = reorderFolder;
const pgClient_1 = require("../../../infrastructure/database/pgClient");
async function createFolder(folder) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('INSERT INTO folders (name, description, parent_id, created_by) VALUES ($1, $2, $3, $4) RETURNING *', [folder.name, folder.description, folder.parentId, folder.createdBy]);
    return result.rows[0];
}
async function getFolderById(id) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM folders WHERE id = $1', [id]);
    return result.rows[0] || null;
}
async function getAllFolders() {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM folders ORDER BY name');
    return result.rows;
}
async function getFolderTree() {
    // 모든 폴더 조회
    const folders = await getAllFolders();
    // 테스트 케이스 수 조회
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const testCaseCounts = await pgClient.query(`
        SELECT folder_id, COUNT(*) as count 
        FROM case_folders 
        GROUP BY folder_id
    `);
    const countMap = new Map();
    testCaseCounts.rows.forEach((row) => {
        countMap.set(row.folder_id, parseInt(row.count));
    });
    // 트리 구조 생성
    const folderMap = new Map();
    const rootFolders = [];
    folders.forEach(folder => {
        const folderTree = {
            ...folder,
            children: [],
            testCaseCount: countMap.get(folder.id) || 0
        };
        folderMap.set(folder.id, folderTree);
    });
    folders.forEach(folder => {
        const folderTree = folderMap.get(folder.id);
        if (folder.parentId) {
            const parent = folderMap.get(folder.parentId);
            if (parent) {
                parent.children.push(folderTree);
            }
        }
        else {
            rootFolders.push(folderTree);
        }
    });
    return rootFolders;
}
async function getFolderTreePaginated(page = 1, limit = 100) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const offset = (page - 1) * limit;
    // 전체 개수 조회
    const countResult = await pgClient.query('SELECT COUNT(*) as total FROM folders');
    const total = parseInt(countResult.rows[0].total);
    // 페이징된 폴더 조회
    const result = await pgClient.query('SELECT * FROM folders ORDER BY name LIMIT $1 OFFSET $2', [limit, offset]);
    const folders = result.rows.map((row) => ({
        ...row,
        children: [],
        testCaseCount: 0
    }));
    return { folders, total };
}
async function getFolderTreeWithLazyLoading(parentId) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const whereClause = parentId ? 'WHERE parent_id = $1' : 'WHERE parent_id IS NULL';
    const params = parentId ? [parentId] : [];
    const result = await pgClient.query(`SELECT * FROM folders ${whereClause} ORDER BY name`, params);
    return result.rows.map((row) => ({
        ...row,
        children: [],
        testCaseCount: 0
    }));
}
async function updateFolder(id, updates) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const fields = [];
    const values = [];
    let paramIndex = 1;
    if (updates.name !== undefined) {
        fields.push(`name = $${paramIndex++}`);
        values.push(updates.name);
    }
    if (updates.description !== undefined) {
        fields.push(`description = $${paramIndex++}`);
        values.push(updates.description);
    }
    if (updates.parentId !== undefined) {
        fields.push(`parent_id = $${paramIndex++}`);
        values.push(updates.parentId);
    }
    fields.push(`updated_at = CURRENT_TIMESTAMP`);
    values.push(id);
    const result = await pgClient.query(`UPDATE folders SET ${fields.join(', ')} WHERE id = $${paramIndex} RETURNING *`, values);
    return result.rows[0] || null;
}
async function deleteFolder(id) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('DELETE FROM folders WHERE id = $1', [id]);
    return (result.rowCount ?? 0) > 0;
}
async function getTestCasesInFolder(folderId) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT testcase_id FROM case_folders WHERE folder_id = $1', [folderId]);
    return result.rows.map((row) => row.testcase_id);
}
async function addTestCaseToFolder(testCaseId, folderId) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('INSERT INTO case_folders (testcase_id, folder_id) VALUES ($1, $2) ON CONFLICT DO NOTHING RETURNING id', [testCaseId, folderId]);
    if (result.rowCount === 0) {
        throw new Error('이미 해당 폴더에 포함된 테스트케이스입니다.');
    }
}
async function removeTestCaseFromFolder(testCaseId, folderId) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    await pgClient.query('DELETE FROM case_folders WHERE testcase_id = $1 AND folder_id = $2', [testCaseId, folderId]);
}
async function moveTestCase(testCaseId, fromFolderId, toFolderId) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    await pgClient.query('BEGIN');
    try {
        await removeTestCaseFromFolder(testCaseId, fromFolderId);
        await addTestCaseToFolder(testCaseId, toFolderId);
        await pgClient.query('COMMIT');
    }
    catch (error) {
        await pgClient.query('ROLLBACK');
        throw error;
    }
}
async function moveTestCasesBatch(testCaseIds, fromFolderId, toFolderId) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    await pgClient.query('BEGIN');
    try {
        // 기존 관계 제거
        await pgClient.query('DELETE FROM case_folders WHERE testcase_id = ANY($1) AND folder_id = $2', [testCaseIds, fromFolderId]);
        // 새 관계 추가 (배치 처리)
        const values = testCaseIds.map((_, index) => `($${index + 1}, $${testCaseIds.length + 1})`).join(', ');
        await pgClient.query(`INSERT INTO case_folders (testcase_id, folder_id) VALUES ${values}`, [...testCaseIds, toFolderId]);
        await pgClient.query('COMMIT');
    }
    catch (error) {
        await pgClient.query('ROLLBACK');
        throw error;
    }
}
async function checkCircularReference(folderId, newParentId) {
    if (!newParentId)
        return false;
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const visited = new Set();
    let currentId = newParentId;
    while (currentId) {
        if (visited.has(currentId) || currentId === folderId) {
            return true; // 순환 참조 발견
        }
        visited.add(currentId);
        const result = await pgClient.query('SELECT parent_id FROM folders WHERE id = $1', [currentId]);
        if (result.rows.length === 0)
            break;
        currentId = result.rows[0].parent_id;
    }
    return false;
}
async function reorderFolder(folderId, targetFolderId, position) {
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    try {
        // 현재 폴더와 타겟 폴더 정보 조회
        const folderResult = await pgClient.query('SELECT * FROM folders WHERE id = $1', [folderId]);
        const targetResult = await pgClient.query('SELECT * FROM folders WHERE id = $1', [targetFolderId]);
        if (folderResult.rows.length === 0 || targetResult.rows.length === 0) {
            return null;
        }
        const folder = folderResult.rows[0];
        const targetFolder = targetResult.rows[0];
        // 같은 부모 폴더 내에서만 순서 변경 가능
        if (folder.parent_id !== targetFolder.parent_id) {
            throw new Error('같은 레벨의 폴더 간에만 순서를 변경할 수 있습니다.');
        }
        // 같은 부모를 가진 모든 폴더 조회 (순서대로)
        const siblingsResult = await pgClient.query('SELECT * FROM folders WHERE parent_id = $1 ORDER BY sort_order, name', [folder.parent_id]);
        const siblings = siblingsResult.rows;
        const folderIndex = siblings.findIndex(f => f.id === folderId);
        const targetIndex = siblings.findIndex(f => f.id === targetFolderId);
        if (folderIndex === -1 || targetIndex === -1) {
            return null;
        }
        // 새로운 순서 계산
        let newIndex;
        if (position === 'before') {
            newIndex = targetIndex;
        }
        else {
            newIndex = targetIndex + 1;
        }
        // 이미 올바른 위치에 있는지 확인
        if (folderIndex === newIndex || (position === 'after' && folderIndex === newIndex - 1)) {
            return folder;
        }
        // sort_order 필드가 있는지 확인하고, 없다면 생성
        const checkSortOrderResult = await pgClient.query(`
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name = 'folders' AND column_name = 'sort_order'
        `);
        if (checkSortOrderResult.rows.length === 0) {
            // sort_order 컬럼 추가
            await pgClient.query('ALTER TABLE folders ADD COLUMN sort_order INTEGER DEFAULT 0');
            console.log('sort_order 컬럼이 추가되었습니다.');
        }
        // 현재 sort_order 값들 업데이트
        const updateSortOrders = async () => {
            // 모든 형제 폴더의 sort_order를 10 단위로 설정
            for (let i = 0; i < siblings.length; i++) {
                await pgClient.query('UPDATE folders SET sort_order = $1 WHERE id = $2', [(i + 1) * 10, siblings[i].id]);
            }
        };
        // 순서 변경 로직
        const reorderSiblings = async () => {
            // 이동할 폴더를 제거
            const siblingsWithoutMoved = siblings.filter(f => f.id !== folderId);
            // 새 위치에 삽입
            const newSiblings = [...siblingsWithoutMoved];
            if (position === 'before') {
                newSiblings.splice(targetIndex, 0, folder);
            }
            else {
                newSiblings.splice(targetIndex + 1, 0, folder);
            }
            // 새로운 sort_order 값들 계산
            const newSortOrders = newSiblings.map((sibling, index) => ({
                id: sibling.id,
                sort_order: (index + 1) * 10
            }));
            // 모든 형제 폴더의 sort_order 업데이트
            for (const { id, sort_order } of newSortOrders) {
                await pgClient.query('UPDATE folders SET sort_order = $1 WHERE id = $2', [sort_order, id]);
            }
        };
        // 트랜잭션 시작
        await pgClient.query('BEGIN');
        try {
            // sort_order 컬럼이 없다면 추가
            if (checkSortOrderResult.rows.length === 0) {
                await updateSortOrders();
            }
            // 순서 변경 실행
            await reorderSiblings();
            // 업데이트된 폴더 정보 조회
            const updatedFolderResult = await pgClient.query('SELECT * FROM folders WHERE id = $1', [folderId]);
            // 트랜잭션 커밋
            await pgClient.query('COMMIT');
            return updatedFolderResult.rows[0] || null;
        }
        catch (error) {
            // 트랜잭션 롤백
            await pgClient.query('ROLLBACK');
            throw error;
        }
    }
    catch (error) {
        console.error('폴더 순서 변경 실패:', error);
        throw error;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy9mb2xkZXJzL3JlcG9zaXRvcmllcy9mb2xkZXJSZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7O0FBR0Esb0NBVUM7QUFFRCxzQ0FPQztBQUVELHNDQU9DO0FBRUQsc0NBOENDO0FBRUQsd0RBd0JDO0FBRUQsb0VBa0JDO0FBRUQsb0NBK0JDO0FBRUQsb0NBT0M7QUFFRCxvREFVQztBQUVELGtEQVlDO0FBRUQsNERBU0M7QUFFRCxvQ0FjQztBQUVELGdEQXlCQztBQUVELHdEQTJCQztBQUVELHNDQWtJQztBQXhaRCx3RUFBd0U7QUFHakUsS0FBSyxVQUFVLFlBQVksQ0FBQyxNQUFzRDtJQUNyRixNQUFNLFFBQVEsR0FBRyxJQUFBLHNCQUFXLEdBQUUsQ0FBQztJQUMvQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDWixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FDL0Isb0dBQW9HLEVBQ3BHLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUN2RSxDQUFDO0lBQ0YsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFCLENBQUM7QUFFTSxLQUFLLFVBQVUsYUFBYSxDQUFDLEVBQVU7SUFDMUMsTUFBTSxRQUFRLEdBQUcsSUFBQSxzQkFBVyxHQUFFLENBQUM7SUFDL0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFDRCxNQUFNLE1BQU0sR0FBRyxNQUFNLFFBQVEsQ0FBQyxLQUFLLENBQUMscUNBQXFDLEVBQUUsQ0FBQyxF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QyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQ25CLENBQUM7WUFDTixDQUFDO1FBQ0wsQ0FBQyxDQUFDO1FBRUYsVUFBVTtRQUNWLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU5QixJQUFJLENBQUM7WUFDRCx3QkFBd0I7WUFDeEIsSUFBSSxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUN6QyxNQUFNLGdCQUFnQixFQUFFLENBQUM7WUFDN0IsQ0FBQztZQUVELFdBQVc7WUFDWCxNQUFNLGVBQWUsRUFBRSxDQUFDO1lBRXhCLGlCQUFpQjtZQUNqQixNQUFNLG1CQUFtQixHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFFcEcsVUFBVTtZQUNWLE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUUvQixPQUFPLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7UUFDL0MsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixVQUFVO1lBQ1YsTUFBTSxRQUFRLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sS0FBSyxDQUFDO1FBQ2hCLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sS0FBSyxDQUFDO0lBQ2hCLENBQUM7QUFDTCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy8zaS1hMS0yMDIxLTAxNy9EZXNrdG9wL215LXByb2plY3Qvc3JjL21haW4vYXBwL2RvbWFpbnMvZm9sZGVycy9yZXBvc2l0b3JpZXMvZm9sZGVyUmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRQZ0NsaWVudCB9IGZyb20gJy4uLy4uLy4uL2luZnJhc3RydWN0dXJlL2RhdGFiYXNlL3BnQ2xpZW50JztcbmltcG9ydCB7IEZvbGRlciwgRm9sZGVyVHJlZSB9IGZyb20gJy4uL21vZGVscy9Gb2xkZXInO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlRm9sZGVyKGZvbGRlcjogT21pdDxGb2xkZXIsICdpZCcgfCAnY3JlYXRlZEF0JyB8ICd1cGRhdGVkQXQnPik6IFByb21pc2U8Rm9sZGVyPiB7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgJ0lOU0VSVCBJTlRPIGZvbGRlcnMgKG5hbWUsIGRlc2NyaXB0aW9uLCBwYXJlbnRfaWQsIGNyZWF0ZWRfYnkpIFZBTFVFUyAoJDEsICQyLCAkMywgJDQpIFJFVFVSTklORyAqJyxcbiAgICAgICAgW2ZvbGRlci5uYW1lLCBmb2xkZXIuZGVzY3JpcHRpb24sIGZvbGRlci5wYXJlbnRJZCwgZm9sZGVyLmNyZWF0ZWRCeV1cbiAgICApO1xuICAgIHJldHVybiByZXN1bHQucm93c1swXTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEZvbGRlckJ5SWQoaWQ6IG51bWJlcik6IFByb21pc2U8Rm9sZGVyIHwgbnVsbD4ge1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoJ1NFTEVDVCAqIEZST00gZm9sZGVycyBXSEVSRSBpZCA9ICQxJywgW2lkXSk7XG4gICAgcmV0dXJuIHJlc3VsdC5yb3dzWzBdIHx8IG51bGw7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBbGxGb2xkZXJzKCk6IFByb21pc2U8Rm9sZGVyW10+IHtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdTRUxFQ1QgKiBGUk9NIGZvbGRlcnMgT1JERVIgQlkgbmFtZScpO1xuICAgIHJldHVybiByZXN1bHQucm93cztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEZvbGRlclRyZWUoKTogUHJvbWlzZTxGb2xkZXJUcmVlW10+IHtcbiAgICAvLyDrqqjrk6Ag7Y+0642UIOyhsO2ajFxuICAgIGNvbnN0IGZvbGRlcnMgPSBhd2FpdCBnZXRBbGxGb2xkZXJzKCk7XG4gICAgXG4gICAgLy8g7YWM7Iqk7Yq4IOy8gOydtOyKpCDsiJgg7KGw7ZqMXG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCB0ZXN0Q2FzZUNvdW50cyA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGBcbiAgICAgICAgU0VMRUNUIGZvbGRlcl9pZCwgQ09VTlQoKikgYXMgY291bnQgXG4gICAgICAgIEZST00gY2FzZV9mb2xkZXJzIFxuICAgICAgICBHUk9VUCBCWSBmb2xkZXJfaWRcbiAgICBgKTtcbiAgICBcbiAgICBjb25zdCBjb3VudE1hcCA9IG5ldyBNYXA8bnVtYmVyLCBudW1iZXI+KCk7XG4gICAgdGVzdENhc2VDb3VudHMucm93cy5mb3JFYWNoKChyb3c6IGFueSkgPT4ge1xuICAgICAgICBjb3VudE1hcC5zZXQocm93LmZvbGRlcl9pZCwgcGFyc2VJbnQocm93LmNvdW50KSk7XG4gICAgfSk7XG4gICAgXG4gICAgLy8g7Yq466asIOq1rOyhsCDsg53shLFcbiAgICBjb25zdCBmb2xkZXJNYXAgPSBuZXcgTWFwPG51bWJlciwgRm9sZGVyVHJlZT4oKTtcbiAgICBjb25zdCByb290Rm9sZGVyczogRm9sZGVyVHJlZVtdID0gW107XG4gICAgXG4gICAgZm9sZGVycy5mb3JFYWNoKGZvbGRlciA9PiB7XG4gICAgICAgIGNvbnN0IGZvbGRlclRyZWU6IEZvbGRlclRyZWUgPSB7XG4gICAgICAgICAgICAuLi5mb2xkZXIsXG4gICAgICAgICAgICBjaGlsZHJlbjogW10sXG4gICAgICAgICAgICB0ZXN0Q2FzZUNvdW50OiBjb3VudE1hcC5nZXQoZm9sZGVyLmlkKSB8fCAwXG4gICAgICAgIH07XG4gICAgICAgIGZvbGRlck1hcC5zZXQoZm9sZGVyLmlkLCBmb2xkZXJUcmVlKTtcbiAgICB9KTtcbiAgICBcbiAgICBmb2xkZXJzLmZvckVhY2goZm9sZGVyID0+IHtcbiAgICAgICAgY29uc3QgZm9sZGVyVHJlZSA9IGZvbGRlck1hcC5nZXQoZm9sZGVyLmlkKSE7XG4gICAgICAgIGlmIChmb2xkZXIucGFyZW50SWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IGZvbGRlck1hcC5nZXQoZm9sZGVyLnBhcmVudElkKTtcbiAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChmb2xkZXJUcmVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJvb3RGb2xkZXJzLnB1c2goZm9sZGVyVHJlZSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICByZXR1cm4gcm9vdEZvbGRlcnM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGb2xkZXJUcmVlUGFnaW5hdGVkKHBhZ2UgPSAxLCBsaW1pdCA9IDEwMCk6IFByb21pc2U8eyBmb2xkZXJzOiBGb2xkZXJUcmVlW10sIHRvdGFsOiBudW1iZXIgfT4ge1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG4gICAgY29uc3Qgb2Zmc2V0ID0gKHBhZ2UgLSAxKSAqIGxpbWl0O1xuICAgIFxuICAgIC8vIOyghOyytCDqsJzsiJgg7KGw7ZqMXG4gICAgY29uc3QgY291bnRSZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnU0VMRUNUIENPVU5UKCopIGFzIHRvdGFsIEZST00gZm9sZGVycycpO1xuICAgIGNvbnN0IHRvdGFsID0gcGFyc2VJbnQoY291bnRSZXN1bHQucm93c1swXS50b3RhbCk7XG4gICAgXG4gICAgLy8g7Y6Y7J207KeV65CcIO2PtOuNlCDsobDtmoxcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgJ1NFTEVDVCAqIEZST00gZm9sZGVycyBPUkRFUiBCWSBuYW1lIExJTUlUICQxIE9GRlNFVCAkMicsXG4gICAgICAgIFtsaW1pdCwgb2Zmc2V0XVxuICAgICk7XG4gICAgXG4gICAgY29uc3QgZm9sZGVycyA9IHJlc3VsdC5yb3dzLm1hcCgocm93OiBhbnkpID0+ICh7XG4gICAgICAgIC4uLnJvdyxcbiAgICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgICB0ZXN0Q2FzZUNvdW50OiAwXG4gICAgfSkpO1xuICAgIFxuICAgIHJldHVybiB7IGZvbGRlcnMsIHRvdGFsIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGb2xkZXJUcmVlV2l0aExhenlMb2FkaW5nKHBhcmVudElkPzogbnVtYmVyKTogUHJvbWlzZTxGb2xkZXJUcmVlW10+IHtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIGNvbnN0IHdoZXJlQ2xhdXNlID0gcGFyZW50SWQgPyAnV0hFUkUgcGFyZW50X2lkID0gJDEnIDogJ1dIRVJFIHBhcmVudF9pZCBJUyBOVUxMJztcbiAgICBjb25zdCBwYXJhbXMgPSBwYXJlbnRJZCA/IFtwYXJlbnRJZF0gOiBbXTtcbiAgICBcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgYFNFTEVDVCAqIEZST00gZm9sZGVycyAke3doZXJlQ2xhdXNlfSBPUkRFUiBCWSBuYW1lYCxcbiAgICAgICAgcGFyYW1zXG4gICAgKTtcbiAgICBcbiAgICByZXR1cm4gcmVzdWx0LnJvd3MubWFwKChyb3c6IGFueSkgPT4gKHtcbiAgICAgICAgLi4ucm93LFxuICAgICAgICBjaGlsZHJlbjogW10sXG4gICAgICAgIHRlc3RDYXNlQ291bnQ6IDBcbiAgICB9KSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVGb2xkZXIoaWQ6IG51bWJlciwgdXBkYXRlczogUGFydGlhbDxGb2xkZXI+KTogUHJvbWlzZTxGb2xkZXIgfCBudWxsPiB7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCBmaWVsZHMgPSBbXTtcbiAgICBjb25zdCB2YWx1ZXMgPSBbXTtcbiAgICBsZXQgcGFyYW1JbmRleCA9IDE7XG4gICAgXG4gICAgaWYgKHVwZGF0ZXMubmFtZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGZpZWxkcy5wdXNoKGBuYW1lID0gJCR7cGFyYW1JbmRleCsrfWApO1xuICAgICAgICB2YWx1ZXMucHVzaCh1cGRhdGVzLm5hbWUpO1xuICAgIH1cbiAgICBpZiAodXBkYXRlcy5kZXNjcmlwdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGZpZWxkcy5wdXNoKGBkZXNjcmlwdGlvbiA9ICQke3BhcmFtSW5kZXgrK31gKTtcbiAgICAgICAgdmFsdWVzLnB1c2godXBkYXRlcy5kZXNjcmlwdGlvbik7XG4gICAgfVxuICAgIGlmICh1cGRhdGVzLnBhcmVudElkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZmllbGRzLnB1c2goYHBhcmVudF9pZCA9ICQke3BhcmFtSW5kZXgrK31gKTtcbiAgICAgICAgdmFsdWVzLnB1c2godXBkYXRlcy5wYXJlbnRJZCk7XG4gICAgfVxuICAgIFxuICAgIGZpZWxkcy5wdXNoKGB1cGRhdGVkX2F0ID0gQ1VSUkVOVF9USU1FU1RBTVBgKTtcbiAgICB2YWx1ZXMucHVzaChpZCk7XG4gICAgXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgIGBVUERBVEUgZm9sZGVycyBTRVQgJHtmaWVsZHMuam9pbignLCAnKX0gV0hFUkUgaWQgPSAkJHtwYXJhbUluZGV4fSBSRVRVUk5JTkcgKmAsXG4gICAgICAgIHZhbHVlc1xuICAgICk7XG4gICAgXG4gICAgcmV0dXJuIHJlc3VsdC5yb3dzWzBdIHx8IG51bGw7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVGb2xkZXIoaWQ6IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoJ0RFTEVURSBGUk9NIGZvbGRlcnMgV0hFUkUgaWQgPSAkMScsIFtpZF0pO1xuICAgIHJldHVybiAocmVzdWx0LnJvd0NvdW50ID8/IDApID4gMDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFRlc3RDYXNlc0luRm9sZGVyKGZvbGRlcklkOiBudW1iZXIpOiBQcm9taXNlPG51bWJlcltdPiB7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgJ1NFTEVDVCB0ZXN0Y2FzZV9pZCBGUk9NIGNhc2VfZm9sZGVycyBXSEVSRSBmb2xkZXJfaWQgPSAkMScsXG4gICAgICAgIFtmb2xkZXJJZF1cbiAgICApO1xuICAgIHJldHVybiByZXN1bHQucm93cy5tYXAoKHJvdzogYW55KSA9PiByb3cudGVzdGNhc2VfaWQpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWRkVGVzdENhc2VUb0ZvbGRlcih0ZXN0Q2FzZUlkOiBudW1iZXIsIGZvbGRlcklkOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KFxuICAgICAgICAnSU5TRVJUIElOVE8gY2FzZV9mb2xkZXJzICh0ZXN0Y2FzZV9pZCwgZm9sZGVyX2lkKSBWQUxVRVMgKCQxLCAkMikgT04gQ09ORkxJQ1QgRE8gTk9USElORyBSRVRVUk5JTkcgaWQnLFxuICAgICAgICBbdGVzdENhc2VJZCwgZm9sZGVySWRdXG4gICAgKTtcbiAgICBpZiAocmVzdWx0LnJvd0NvdW50ID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcign7J2066+4IO2VtOuLuSDtj7TrjZTsl5Ag7Y+s7ZWo65CcIO2FjOyKpO2KuOy8gOydtOyKpOyeheuLiOuLpC4nKTtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW1vdmVUZXN0Q2FzZUZyb21Gb2xkZXIodGVzdENhc2VJZDogbnVtYmVyLCBmb2xkZXJJZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgJ0RFTEVURSBGUk9NIGNhc2VfZm9sZGVycyBXSEVSRSB0ZXN0Y2FzZV9pZCA9ICQxIEFORCBmb2xkZXJfaWQgPSAkMicsXG4gICAgICAgIFt0ZXN0Q2FzZUlkLCBmb2xkZXJJZF1cbiAgICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbW92ZVRlc3RDYXNlKHRlc3RDYXNlSWQ6IG51bWJlciwgZnJvbUZvbGRlcklkOiBudW1iZXIsIHRvRm9sZGVySWQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG4gICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0JFR0lOJyk7XG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcmVtb3ZlVGVzdENhc2VGcm9tRm9sZGVyKHRlc3RDYXNlSWQsIGZyb21Gb2xkZXJJZCk7XG4gICAgICAgIGF3YWl0IGFkZFRlc3RDYXNlVG9Gb2xkZXIodGVzdENhc2VJZCwgdG9Gb2xkZXJJZCk7XG4gICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdDT01NSVQnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnUk9MTEJBQ0snKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbW92ZVRlc3RDYXNlc0JhdGNoKHRlc3RDYXNlSWRzOiBudW1iZXJbXSwgZnJvbUZvbGRlcklkOiBudW1iZXIsIHRvRm9sZGVySWQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG4gICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0JFR0lOJyk7XG4gICAgdHJ5IHtcbiAgICAgICAgLy8g6riw7KG0IOq0gOqzhCDsoJzqsbBcbiAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgICAgICAnREVMRVRFIEZST00gY2FzZV9mb2xkZXJzIFdIRVJFIHRlc3RjYXNlX2lkID0gQU5ZKCQxKSBBTkQgZm9sZGVyX2lkID0gJDInLFxuICAgICAgICAgICAgW3Rlc3RDYXNlSWRzLCBmcm9tRm9sZGVySWRdXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgICAvLyDsg4gg6rSA6rOEIOy2lOqwgCAo67Cw7LmYIOyymOumrClcbiAgICAgICAgY29uc3QgdmFsdWVzID0gdGVzdENhc2VJZHMubWFwKChfLCBpbmRleCkgPT4gYCgkJHtpbmRleCArIDF9LCAkJHt0ZXN0Q2FzZUlkcy5sZW5ndGggKyAxfSlgKS5qb2luKCcsICcpO1xuICAgICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgICAgIGBJTlNFUlQgSU5UTyBjYXNlX2ZvbGRlcnMgKHRlc3RjYXNlX2lkLCBmb2xkZXJfaWQpIFZBTFVFUyAke3ZhbHVlc31gLFxuICAgICAgICAgICAgWy4uLnRlc3RDYXNlSWRzLCB0b0ZvbGRlcklkXVxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0NPTU1JVCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdST0xMQkFDSycpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGVja0NpcmN1bGFyUmVmZXJlbmNlKGZvbGRlcklkOiBudW1iZXIsIG5ld1BhcmVudElkOiBudW1iZXIpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAoIW5ld1BhcmVudElkKSByZXR1cm4gZmFsc2U7XG4gICAgXG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCB2aXNpdGVkID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgbGV0IGN1cnJlbnRJZCA9IG5ld1BhcmVudElkO1xuICAgIFxuICAgIHdoaWxlIChjdXJyZW50SWQpIHtcbiAgICAgICAgaWYgKHZpc2l0ZWQuaGFzKGN1cnJlbnRJZCkgfHwgY3VycmVudElkID09PSBmb2xkZXJJZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIOyInO2ZmCDssLjsobAg67Cc6rKsXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHZpc2l0ZWQuYWRkKGN1cnJlbnRJZCk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KFxuICAgICAgICAgICAgJ1NFTEVDVCBwYXJlbnRfaWQgRlJPTSBmb2xkZXJzIFdIRVJFIGlkID0gJDEnLFxuICAgICAgICAgICAgW2N1cnJlbnRJZF1cbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChyZXN1bHQucm93cy5sZW5ndGggPT09IDApIGJyZWFrO1xuICAgICAgICBjdXJyZW50SWQgPSByZXN1bHQucm93c1swXS5wYXJlbnRfaWQ7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlb3JkZXJGb2xkZXIoZm9sZGVySWQ6IG51bWJlciwgdGFyZ2V0Rm9sZGVySWQ6IG51bWJlciwgcG9zaXRpb246ICdiZWZvcmUnIHwgJ2FmdGVyJyk6IFByb21pc2U8Rm9sZGVyIHwgbnVsbD4ge1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgICAvLyDtmITsnqwg7Y+0642U7JmAIO2DgOqynyDtj7TrjZQg7KCV67O0IOyhsO2ajFxuICAgICAgICBjb25zdCBmb2xkZXJSZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnU0VMRUNUICogRlJPTSBmb2xkZXJzIFdIRVJFIGlkID0gJDEnLCBbZm9sZGVySWRdKTtcbiAgICAgICAgY29uc3QgdGFyZ2V0UmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoJ1NFTEVDVCAqIEZST00gZm9sZGVycyBXSEVSRSBpZCA9ICQxJywgW3RhcmdldEZvbGRlcklkXSk7XG5cbiAgICAgICAgaWYgKGZvbGRlclJlc3VsdC5yb3dzLmxlbmd0aCA9PT0gMCB8fCB0YXJnZXRSZXN1bHQucm93cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZm9sZGVyID0gZm9sZGVyUmVzdWx0LnJvd3NbMF07XG4gICAgICAgIGNvbnN0IHRhcmdldEZvbGRlciA9IHRhcmdldFJlc3VsdC5yb3dzWzBdO1xuXG4gICAgICAgIC8vIOqwmeydgCDrtoDrqqgg7Y+0642UIOuCtOyXkOyEnOunjCDsiJzshJwg67OA6rK9IOqwgOuKpVxuICAgICAgICBpZiAoZm9sZGVyLnBhcmVudF9pZCAhPT0gdGFyZ2V0Rm9sZGVyLnBhcmVudF9pZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfqsJnsnYAg66CI67Ko7J2YIO2PtOuNlCDqsITsl5Drp4wg7Iic7ISc66W8IOuzgOqyve2VoCDsiJgg7J6I7Iq164uI64ukLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g6rCZ7J2AIOu2gOuqqOulvCDqsIDsp4Qg66qo65OgIO2PtOuNlCDsobDtmowgKOyInOyEnOuMgOuhnClcbiAgICAgICAgY29uc3Qgc2libGluZ3NSZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgICAgICdTRUxFQ1QgKiBGUk9NIGZvbGRlcnMgV0hFUkUgcGFyZW50X2lkID0gJDEgT1JERVIgQlkgc29ydF9vcmRlciwgbmFtZScsXG4gICAgICAgICAgICBbZm9sZGVyLnBhcmVudF9pZF1cbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBzaWJsaW5ncyA9IHNpYmxpbmdzUmVzdWx0LnJvd3M7XG4gICAgICAgIGNvbnN0IGZvbGRlckluZGV4ID0gc2libGluZ3MuZmluZEluZGV4KGYgPT4gZi5pZCA9PT0gZm9sZGVySWQpO1xuICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IHNpYmxpbmdzLmZpbmRJbmRleChmID0+IGYuaWQgPT09IHRhcmdldEZvbGRlcklkKTtcblxuICAgICAgICBpZiAoZm9sZGVySW5kZXggPT09IC0xIHx8IHRhcmdldEluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDsg4jroZzsmrQg7Iic7IScIOqzhOyCsFxuICAgICAgICBsZXQgbmV3SW5kZXg6IG51bWJlcjtcbiAgICAgICAgaWYgKHBvc2l0aW9uID09PSAnYmVmb3JlJykge1xuICAgICAgICAgICAgbmV3SW5kZXggPSB0YXJnZXRJbmRleDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5ld0luZGV4ID0gdGFyZ2V0SW5kZXggKyAxO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g7J2066+4IOyYrOuwlOuluCDsnITsuZjsl5Ag7J6I64qU7KeAIO2ZleyduFxuICAgICAgICBpZiAoZm9sZGVySW5kZXggPT09IG5ld0luZGV4IHx8IChwb3NpdGlvbiA9PT0gJ2FmdGVyJyAmJiBmb2xkZXJJbmRleCA9PT0gbmV3SW5kZXggLSAxKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZvbGRlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHNvcnRfb3JkZXIg7ZWE65Oc6rCAIOyeiOuKlOyngCDtmZXsnbjtlZjqs6AsIOyXhuuLpOuptCDsg53shLFcbiAgICAgICAgY29uc3QgY2hlY2tTb3J0T3JkZXJSZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShgXG4gICAgICAgICAgICBTRUxFQ1QgY29sdW1uX25hbWUgXG4gICAgICAgICAgICBGUk9NIGluZm9ybWF0aW9uX3NjaGVtYS5jb2x1bW5zIFxuICAgICAgICAgICAgV0hFUkUgdGFibGVfbmFtZSA9ICdmb2xkZXJzJyBBTkQgY29sdW1uX25hbWUgPSAnc29ydF9vcmRlcidcbiAgICAgICAgYCk7XG5cbiAgICAgICAgaWYgKGNoZWNrU29ydE9yZGVyUmVzdWx0LnJvd3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAvLyBzb3J0X29yZGVyIOy7rOufvCDstpTqsIBcbiAgICAgICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdBTFRFUiBUQUJMRSBmb2xkZXJzIEFERCBDT0xVTU4gc29ydF9vcmRlciBJTlRFR0VSIERFRkFVTFQgMCcpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ3NvcnRfb3JkZXIg7Lus65+87J20IOy2lOqwgOuQmOyXiOyKteuLiOuLpC4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIO2YhOyerCBzb3J0X29yZGVyIOqwkuuTpCDsl4XrjbDsnbTtirhcbiAgICAgICAgY29uc3QgdXBkYXRlU29ydE9yZGVycyA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIC8vIOuqqOuToCDtmJXsoJwg7Y+0642U7J2YIHNvcnRfb3JkZXLrpbwgMTAg64uo7JyE66GcIOyEpOyglVxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaWJsaW5ncy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KFxuICAgICAgICAgICAgICAgICAgICAnVVBEQVRFIGZvbGRlcnMgU0VUIHNvcnRfb3JkZXIgPSAkMSBXSEVSRSBpZCA9ICQyJyxcbiAgICAgICAgICAgICAgICAgICAgWyhpICsgMSkgKiAxMCwgc2libGluZ3NbaV0uaWRdXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvLyDsiJzshJwg67OA6rK9IOuhnOyngVxuICAgICAgICBjb25zdCByZW9yZGVyU2libGluZ3MgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAvLyDsnbTrj5ntlaAg7Y+0642U66W8IOygnOqxsFxuICAgICAgICAgICAgY29uc3Qgc2libGluZ3NXaXRob3V0TW92ZWQgPSBzaWJsaW5ncy5maWx0ZXIoZiA9PiBmLmlkICE9PSBmb2xkZXJJZCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIOyDiCDsnITsuZjsl5Ag7IK97J6FXG4gICAgICAgICAgICBjb25zdCBuZXdTaWJsaW5ncyA9IFsuLi5zaWJsaW5nc1dpdGhvdXRNb3ZlZF07XG4gICAgICAgICAgICBpZiAocG9zaXRpb24gPT09ICdiZWZvcmUnKSB7XG4gICAgICAgICAgICAgICAgbmV3U2libGluZ3Muc3BsaWNlKHRhcmdldEluZGV4LCAwLCBmb2xkZXIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXdTaWJsaW5ncy5zcGxpY2UodGFyZ2V0SW5kZXggKyAxLCAwLCBmb2xkZXIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyDsg4jroZzsmrQgc29ydF9vcmRlciDqsJLrk6Qg6rOE7IKwXG4gICAgICAgICAgICBjb25zdCBuZXdTb3J0T3JkZXJzID0gbmV3U2libGluZ3MubWFwKChzaWJsaW5nLCBpbmRleCkgPT4gKHtcbiAgICAgICAgICAgICAgICBpZDogc2libGluZy5pZCxcbiAgICAgICAgICAgICAgICBzb3J0X29yZGVyOiAoaW5kZXggKyAxKSAqIDEwXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIC8vIOuqqOuToCDtmJXsoJwg7Y+0642U7J2YIHNvcnRfb3JkZXIg7JeF642w7J207Yq4XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHsgaWQsIHNvcnRfb3JkZXIgfSBvZiBuZXdTb3J0T3JkZXJzKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgICAgICAgICAgICAgICdVUERBVEUgZm9sZGVycyBTRVQgc29ydF9vcmRlciA9ICQxIFdIRVJFIGlkID0gJDInLFxuICAgICAgICAgICAgICAgICAgICBbc29ydF9vcmRlciwgaWRdXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvLyDtirjrnpzsnq3shZgg7Iuc7J6RXG4gICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdCRUdJTicpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBzb3J0X29yZGVyIOy7rOufvOydtCDsl4bri6TrqbQg7LaU6rCAXG4gICAgICAgICAgICBpZiAoY2hlY2tTb3J0T3JkZXJSZXN1bHQucm93cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB1cGRhdGVTb3J0T3JkZXJzKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIOyInOyEnCDrs4Dqsr0g7Iuk7ZaJXG4gICAgICAgICAgICBhd2FpdCByZW9yZGVyU2libGluZ3MoKTtcblxuICAgICAgICAgICAgLy8g7JeF642w7J207Yq465CcIO2PtOuNlCDsoJXrs7Qg7KGw7ZqMXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVkRm9sZGVyUmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoJ1NFTEVDVCAqIEZST00gZm9sZGVycyBXSEVSRSBpZCA9ICQxJywgW2ZvbGRlcklkXSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIO2KuOuenOyereyFmCDsu6TrsItcbiAgICAgICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdDT01NSVQnKTtcblxuICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRGb2xkZXJSZXN1bHQucm93c1swXSB8fCBudWxsO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgLy8g7Yq4656c7J6t7IWYIOuhpOuwsVxuICAgICAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ1JPTExCQUNLJyk7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+2PtOuNlCDsiJzshJwg67OA6rK9IOyLpO2MqDonLCBlcnJvcik7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbn0gIl0sInZlcnNpb24iOjN9