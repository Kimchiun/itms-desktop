bb5d3e6f4033a2d97e46b0816f7de0df
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createTestCase = createTestCase;
exports.getTestCaseById = getTestCaseById;
exports.updateTestCase = updateTestCase;
exports.deleteTestCase = deleteTestCase;
exports.listTestCases = listTestCases;
exports.createTestCaseVersion = createTestCaseVersion;
exports.listTestCaseVersions = listTestCaseVersions;
const pgClient_1 = require("../../../infrastructure/database/pgClient");
async function createTestCase(tc) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    // 새로운 구조에 맞게 매핑
    const result = await pgClient.query(`INSERT INTO testcases (title, prereq, steps, expected, priority, tags, status, created_by, folder_id, sort_order) 
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING *`, [
        tc.title,
        tc.prereq,
        JSON.stringify(tc.steps),
        tc.expected,
        tc.priority,
        tc.tags,
        tc.status,
        tc.createdBy,
        tc.folderId || null,
        tc.sortOrder || 0
    ]);
    return rowToTestCase(result.rows[0]);
}
async function getTestCaseById(id) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM testcases WHERE id = $1', [id]);
    if (result.rows.length === 0)
        return null;
    return rowToTestCase(result.rows[0]);
}
async function updateTestCase(id, patch) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const current = await getTestCaseById(id);
    if (!current)
        return null;
    const result = await pgClient.query(`UPDATE testcases SET title=$1, prereq=$2, steps=$3, expected=$4, priority=$5, tags=$6, status=$7, updated_at=NOW() WHERE id=$8 RETURNING *`, [
        patch.title ?? current.title,
        patch.prereq ?? current.prereq,
        JSON.stringify(patch.steps ?? current.steps),
        patch.expected ?? current.expected,
        patch.priority ?? current.priority,
        patch.tags ?? current.tags,
        patch.status ?? current.status,
        id
    ]);
    if (result.rows.length === 0)
        return null;
    return rowToTestCase(result.rows[0]);
}
async function deleteTestCase(id) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    await pgClient.query('DELETE FROM testcase_versions WHERE testcase_id = $1', [id]);
    const result = await pgClient.query('DELETE FROM testcases WHERE id = $1', [id]);
    return (result.rowCount ?? 0) > 0;
}
async function listTestCases() {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM testcases ORDER BY id DESC');
    return result.rows.map(rowToTestCase);
}
async function createTestCaseVersion(tcVersion) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query(`INSERT INTO testcase_versions (testcase_id, version, data, created_by) VALUES ($1, $2, $3, $4) RETURNING *`, [tcVersion.testcaseId, tcVersion.version, JSON.stringify(tcVersion.data), tcVersion.createdBy]);
    return rowToTestCaseVersion(result.rows[0]);
}
async function listTestCaseVersions(testcaseId) {
    await (0, pgClient_1.ensurePgConnected)();
    const pgClient = (0, pgClient_1.getPgClient)();
    if (!pgClient) {
        throw new Error('PostgreSQL 클라이언트가 초기화되지 않았습니다.');
    }
    const result = await pgClient.query('SELECT * FROM testcase_versions WHERE testcase_id = $1 ORDER BY version DESC', [testcaseId]);
    return result.rows.map(rowToTestCaseVersion);
}
function rowToTestCase(row) {
    // steps 필드 안전한 파싱
    let steps = [];
    if (row.steps) {
        try {
            // JSON 문자열인 경우
            if (typeof row.steps === 'string' && row.steps.startsWith('[')) {
                steps = JSON.parse(row.steps);
            }
            else {
                // 일반 텍스트인 경우 배열로 변환
                steps = [row.steps];
            }
        }
        catch (error) {
            // 파싱 실패 시 빈 배열로 설정
            steps = [];
        }
    }
    return {
        id: row.id,
        title: row.title,
        prereq: row.prereq,
        steps: steps,
        expected: row.expected,
        priority: row.priority,
        tags: row.tags,
        status: row.status,
        createdBy: row.created_by,
        createdAt: row.created_at,
        updatedAt: row.updated_at,
        folderId: row.folder_id,
        sortOrder: row.sort_order,
    };
}
function rowToTestCaseVersion(row) {
    let dataObj;
    if (typeof row.data === 'string') {
        dataObj = JSON.parse(row.data);
    }
    else {
        dataObj = row.data;
    }
    return {
        id: row.id,
        testcaseId: row.testcase_id,
        version: row.version,
        data: dataObj,
        createdAt: row.created_at,
        createdBy: row.created_by,
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy90ZXN0Y2FzZXMvcmVwb3NpdG9yaWVzL3Rlc3RDYXNlUmVwb3NpdG9yeS50cyIsIm1hcHBpbmdzIjoiOztBQUdBLHdDQXlCQztBQUVELDBDQVNDO0FBRUQsd0NBdUJDO0FBRUQsd0NBU0M7QUFFRCxzQ0FRQztBQUVELHNEQVdDO0FBRUQsb0RBUUM7QUE1R0Qsd0VBQTJGO0FBR3BGLEtBQUssVUFBVSxjQUFjLENBQUMsRUFBb0Q7SUFDckYsTUFBTSxJQUFBLDRCQUFpQixHQUFFLENBQUM7SUFDMUIsTUFBTSxRQUFRLEdBQUcsSUFBQSxzQkFBVyxHQUFFLENBQUM7SUFDL0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxnQkFBZ0I7SUFDaEIsTUFBTSxNQUFNLEdBQUcsTUFBTSxRQUFRLENBQUMsS0FBSyxDQUMvQjtzRUFDOEQsRUFDOUQ7UUFDSSxFQUFFLENBQUMsS0FBSztRQUNSLEVBQUUsQ0FBQyxNQUFNO1FBQ1QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDO1FBQ3hCLEVBQUUsQ0FBQyxRQUFRO1FBQ1gsRUFBRSxDQUFDLFFBQVE7UUFDWCxFQUFFLENBQUMsSUFBSTtRQUNQLEVBQUUsQ0FBQyxNQUFNO1FBQ1QsRUFBRSxDQUFDLFNBQVM7UUFDWixFQUFFLENBQUMsUUFBUSxJQUFJLElBQUk7UUFDbkIsRUFBRSxDQUFDLFNBQVMsSUFBSSxDQUFDO0tBQ3BCLENBQ0osQ0FBQztJQUNGLE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBRU0sS0FBSyxVQUFVLGVBQWUsQ0FBQyxFQUFVO0lBQzVDLE1BQU0sSUFBQSw0QkFBaUIsR0FBRSxDQUFDO0lBQzFCLE1BQU0sUUFBUSxH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QztJQUNaLElBQUksT0FBTyxHQUFHLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQy9CLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQyxDQUFDO1NBQU0sQ0FBQztRQUNKLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxPQUFPO1FBQ0gsRUFBRSxFQUFFLEdBQUcsQ0FBQyxFQUFFO1FBQ1YsVUFBVSxFQUFFLEdBQUcsQ0FBQyxXQUFXO1FBQzNCLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTztRQUNwQixJQUFJLEVBQUUsT0FBTztRQUNiLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVTtRQUN6QixTQUFTLEVBQUUsR0FBRyxDQUFDLFVBQVU7S0FDNUIsQ0FBQztBQUNOLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy90ZXN0Y2FzZXMvcmVwb3NpdG9yaWVzL3Rlc3RDYXNlUmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRQZ0NsaWVudCwgZW5zdXJlUGdDb25uZWN0ZWQgfSBmcm9tICcuLi8uLi8uLi9pbmZyYXN0cnVjdHVyZS9kYXRhYmFzZS9wZ0NsaWVudCc7XG5pbXBvcnQgeyBUZXN0Q2FzZSwgVGVzdENhc2VWZXJzaW9uIH0gZnJvbSAnLi4vbW9kZWxzL1Rlc3RDYXNlJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRlc3RDYXNlKHRjOiBPbWl0PFRlc3RDYXNlLCAnaWQnIHwgJ2NyZWF0ZWRBdCcgfCAndXBkYXRlZEF0Jz4pOiBQcm9taXNlPFRlc3RDYXNlPiB7XG4gICAgYXdhaXQgZW5zdXJlUGdDb25uZWN0ZWQoKTtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIFxuICAgIC8vIOyDiOuhnOyatCDqtazsobDsl5Ag66ee6rKMIOunpO2VkVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KFxuICAgICAgICBgSU5TRVJUIElOVE8gdGVzdGNhc2VzICh0aXRsZSwgcHJlcmVxLCBzdGVwcywgZXhwZWN0ZWQsIHByaW9yaXR5LCB0YWdzLCBzdGF0dXMsIGNyZWF0ZWRfYnksIGZvbGRlcl9pZCwgc29ydF9vcmRlcikgXG4gICAgICAgICBWQUxVRVMgKCQxLCAkMiwgJDMsICQ0LCAkNSwgJDYsICQ3LCAkOCwgJDksICQxMCkgUkVUVVJOSU5HICpgLFxuICAgICAgICBbXG4gICAgICAgICAgICB0Yy50aXRsZSwgXG4gICAgICAgICAgICB0Yy5wcmVyZXEsIFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGMuc3RlcHMpLCBcbiAgICAgICAgICAgIHRjLmV4cGVjdGVkLCBcbiAgICAgICAgICAgIHRjLnByaW9yaXR5LCBcbiAgICAgICAgICAgIHRjLnRhZ3MsIFxuICAgICAgICAgICAgdGMuc3RhdHVzLCBcbiAgICAgICAgICAgIHRjLmNyZWF0ZWRCeSxcbiAgICAgICAgICAgIHRjLmZvbGRlcklkIHx8IG51bGwsXG4gICAgICAgICAgICB0Yy5zb3J0T3JkZXIgfHwgMFxuICAgICAgICBdXG4gICAgKTtcbiAgICByZXR1cm4gcm93VG9UZXN0Q2FzZShyZXN1bHQucm93c1swXSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRUZXN0Q2FzZUJ5SWQoaWQ6IG51bWJlcik6IFByb21pc2U8VGVzdENhc2UgfCBudWxsPiB7XG4gICAgYXdhaXQgZW5zdXJlUGdDb25uZWN0ZWQoKTtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdTRUxFQ1QgKiBGUk9NIHRlc3RjYXNlcyBXSEVSRSBpZCA9ICQxJywgW2lkXSk7XG4gICAgaWYgKHJlc3VsdC5yb3dzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIHJvd1RvVGVzdENhc2UocmVzdWx0LnJvd3NbMF0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlVGVzdENhc2UoaWQ6IG51bWJlciwgcGF0Y2g6IFBhcnRpYWw8VGVzdENhc2U+KTogUHJvbWlzZTxUZXN0Q2FzZSB8IG51bGw+IHtcbiAgICBhd2FpdCBlbnN1cmVQZ0Nvbm5lY3RlZCgpO1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG4gICAgY29uc3QgY3VycmVudCA9IGF3YWl0IGdldFRlc3RDYXNlQnlJZChpZCk7XG4gICAgaWYgKCFjdXJyZW50KSByZXR1cm4gbnVsbDtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgYFVQREFURSB0ZXN0Y2FzZXMgU0VUIHRpdGxlPSQxLCBwcmVyZXE9JDIsIHN0ZXBzPSQzLCBleHBlY3RlZD0kNCwgcHJpb3JpdHk9JDUsIHRhZ3M9JDYsIHN0YXR1cz0kNywgdXBkYXRlZF9hdD1OT1coKSBXSEVSRSBpZD0kOCBSRVRVUk5JTkcgKmAsXG4gICAgICAgIFtcbiAgICAgICAgICAgIHBhdGNoLnRpdGxlID8/IGN1cnJlbnQudGl0bGUsXG4gICAgICAgICAgICBwYXRjaC5wcmVyZXEgPz8gY3VycmVudC5wcmVyZXEsXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeShwYXRjaC5zdGVwcyA/PyBjdXJyZW50LnN0ZXBzKSxcbiAgICAgICAgICAgIHBhdGNoLmV4cGVjdGVkID8/IGN1cnJlbnQuZXhwZWN0ZWQsXG4gICAgICAgICAgICBwYXRjaC5wcmlvcml0eSA/PyBjdXJyZW50LnByaW9yaXR5LFxuICAgICAgICAgICAgcGF0Y2gudGFncyA/PyBjdXJyZW50LnRhZ3MsXG4gICAgICAgICAgICBwYXRjaC5zdGF0dXMgPz8gY3VycmVudC5zdGF0dXMsXG4gICAgICAgICAgICBpZFxuICAgICAgICBdXG4gICAgKTtcbiAgICBpZiAocmVzdWx0LnJvd3MubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDtcbiAgICByZXR1cm4gcm93VG9UZXN0Q2FzZShyZXN1bHQucm93c1swXSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVUZXN0Q2FzZShpZDogbnVtYmVyKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgYXdhaXQgZW5zdXJlUGdDb25uZWN0ZWQoKTtcbiAgICBjb25zdCBwZ0NsaWVudCA9IGdldFBnQ2xpZW50KCk7XG4gICAgaWYgKCFwZ0NsaWVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bvc3RncmVTUUwg7YG065287J207Ja47Yq46rCAIOy0iOq4sO2ZlOuQmOyngCDslYrslZjsirXri4jri6QuJyk7XG4gICAgfVxuICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdERUxFVEUgRlJPTSB0ZXN0Y2FzZV92ZXJzaW9ucyBXSEVSRSB0ZXN0Y2FzZV9pZCA9ICQxJywgW2lkXSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoJ0RFTEVURSBGUk9NIHRlc3RjYXNlcyBXSEVSRSBpZCA9ICQxJywgW2lkXSk7XG4gICAgcmV0dXJuIChyZXN1bHQucm93Q291bnQgPz8gMCkgPiAwO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdFRlc3RDYXNlcygpOiBQcm9taXNlPFRlc3RDYXNlW10+IHtcbiAgICBhd2FpdCBlbnN1cmVQZ0Nvbm5lY3RlZCgpO1xuICAgIGNvbnN0IHBnQ2xpZW50ID0gZ2V0UGdDbGllbnQoKTtcbiAgICBpZiAoIXBnQ2xpZW50KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUG9zdGdyZVNRTCDtgbTrnbzsnbTslrjtirjqsIAg7LSI6riw7ZmU65CY7KeAIOyViuyVmOyKteuLiOuLpC4nKTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoJ1NFTEVDVCAqIEZST00gdGVzdGNhc2VzIE9SREVSIEJZIGlkIERFU0MnKTtcbiAgICByZXR1cm4gcmVzdWx0LnJvd3MubWFwKHJvd1RvVGVzdENhc2UpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlVGVzdENhc2VWZXJzaW9uKHRjVmVyc2lvbjogT21pdDxUZXN0Q2FzZVZlcnNpb24sICdpZCcgfCAnY3JlYXRlZEF0Jz4pOiBQcm9taXNlPFRlc3RDYXNlVmVyc2lvbj4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgYElOU0VSVCBJTlRPIHRlc3RjYXNlX3ZlcnNpb25zICh0ZXN0Y2FzZV9pZCwgdmVyc2lvbiwgZGF0YSwgY3JlYXRlZF9ieSkgVkFMVUVTICgkMSwgJDIsICQzLCAkNCkgUkVUVVJOSU5HICpgLFxuICAgICAgICBbdGNWZXJzaW9uLnRlc3RjYXNlSWQsIHRjVmVyc2lvbi52ZXJzaW9uLCBKU09OLnN0cmluZ2lmeSh0Y1ZlcnNpb24uZGF0YSksIHRjVmVyc2lvbi5jcmVhdGVkQnldXG4gICAgKTtcbiAgICByZXR1cm4gcm93VG9UZXN0Q2FzZVZlcnNpb24ocmVzdWx0LnJvd3NbMF0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGlzdFRlc3RDYXNlVmVyc2lvbnModGVzdGNhc2VJZDogbnVtYmVyKTogUHJvbWlzZTxUZXN0Q2FzZVZlcnNpb25bXT4ge1xuICAgIGF3YWl0IGVuc3VyZVBnQ29ubmVjdGVkKCk7XG4gICAgY29uc3QgcGdDbGllbnQgPSBnZXRQZ0NsaWVudCgpO1xuICAgIGlmICghcGdDbGllbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQb3N0Z3JlU1FMIO2BtOudvOydtOyWuO2KuOqwgCDstIjquLDtmZTrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnU0VMRUNUICogRlJPTSB0ZXN0Y2FzZV92ZXJzaW9ucyBXSEVSRSB0ZXN0Y2FzZV9pZCA9ICQxIE9SREVSIEJZIHZlcnNpb24gREVTQycsIFt0ZXN0Y2FzZUlkXSk7XG4gICAgcmV0dXJuIHJlc3VsdC5yb3dzLm1hcChyb3dUb1Rlc3RDYXNlVmVyc2lvbik7XG59XG5cbmZ1bmN0aW9uIHJvd1RvVGVzdENhc2Uocm93OiBhbnkpOiBUZXN0Q2FzZSB7XG4gICAgLy8gc3RlcHMg7ZWE65OcIOyViOyghO2VnCDtjIzsi7FcbiAgICBsZXQgc3RlcHM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHJvdy5zdGVwcykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gSlNPTiDrrLjsnpDsl7Tsnbgg6rK97JqwXG4gICAgICAgICAgICBpZiAodHlwZW9mIHJvdy5zdGVwcyA9PT0gJ3N0cmluZycgJiYgcm93LnN0ZXBzLnN0YXJ0c1dpdGgoJ1snKSkge1xuICAgICAgICAgICAgICAgIHN0ZXBzID0gSlNPTi5wYXJzZShyb3cuc3RlcHMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyDsnbzrsJgg7YWN7Iqk7Yq47J24IOqyveyasCDrsLDsl7TroZwg67OA7ZmYXG4gICAgICAgICAgICAgICAgc3RlcHMgPSBbcm93LnN0ZXBzXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIC8vIO2MjOyLsSDsi6TtjKgg7IucIOu5iCDrsLDsl7TroZwg7ISk7KCVXG4gICAgICAgICAgICBzdGVwcyA9IFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IHJvdy5pZCxcbiAgICAgICAgdGl0bGU6IHJvdy50aXRsZSxcbiAgICAgICAgcHJlcmVxOiByb3cucHJlcmVxLFxuICAgICAgICBzdGVwczogc3RlcHMsXG4gICAgICAgIGV4cGVjdGVkOiByb3cuZXhwZWN0ZWQsXG4gICAgICAgIHByaW9yaXR5OiByb3cucHJpb3JpdHksXG4gICAgICAgIHRhZ3M6IHJvdy50YWdzLFxuICAgICAgICBzdGF0dXM6IHJvdy5zdGF0dXMsXG4gICAgICAgIGNyZWF0ZWRCeTogcm93LmNyZWF0ZWRfYnksXG4gICAgICAgIGNyZWF0ZWRBdDogcm93LmNyZWF0ZWRfYXQsXG4gICAgICAgIHVwZGF0ZWRBdDogcm93LnVwZGF0ZWRfYXQsXG4gICAgICAgIGZvbGRlcklkOiByb3cuZm9sZGVyX2lkLFxuICAgICAgICBzb3J0T3JkZXI6IHJvdy5zb3J0X29yZGVyLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHJvd1RvVGVzdENhc2VWZXJzaW9uKHJvdzogYW55KTogVGVzdENhc2VWZXJzaW9uIHtcbiAgICBsZXQgZGF0YU9iajtcbiAgICBpZiAodHlwZW9mIHJvdy5kYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhT2JqID0gSlNPTi5wYXJzZShyb3cuZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZGF0YU9iaiA9IHJvdy5kYXRhO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBpZDogcm93LmlkLFxuICAgICAgICB0ZXN0Y2FzZUlkOiByb3cudGVzdGNhc2VfaWQsXG4gICAgICAgIHZlcnNpb246IHJvdy52ZXJzaW9uLFxuICAgICAgICBkYXRhOiBkYXRhT2JqLFxuICAgICAgICBjcmVhdGVkQXQ6IHJvdy5jcmVhdGVkX2F0LFxuICAgICAgICBjcmVhdGVkQnk6IHJvdy5jcmVhdGVkX2J5LFxuICAgIH07XG59ICJdLCJ2ZXJzaW9uIjozfQ==