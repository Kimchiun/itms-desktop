9d3a763ce40e7d9939784eee188a8187
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.defectRepository = void 0;
const pgClient_1 = __importDefault(require("../../../infrastructure/database/pgClient"));
class DefectRepository {
    async create(defect) {
        const query = `
            INSERT INTO defects (
                title, description, status, priority, assignee, reporter, 
                created_by, test_case_id, release_id, created_at, updated_at
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
            RETURNING *
        `;
        const values = [
            defect.title,
            defect.description,
            defect.status,
            defect.priority,
            defect.assignee,
            defect.reporter,
            defect.createdBy,
            defect.testCaseId,
            defect.releaseId,
            defect.createdAt,
            defect.updatedAt
        ];
        const result = await pgClient_1.default.query(query, values);
        return result.rows[0];
    }
    async update(id, updates) {
        const setClause = Object.keys(updates)
            .filter(key => key !== 'id')
            .map((key, index) => `${key} = $${index + 2}`)
            .join(', ');
        const query = `
            UPDATE defects 
            SET ${setClause}
            WHERE id = $1
            RETURNING *
        `;
        const values = [id, ...Object.values(updates).filter(val => val !== undefined)];
        const result = await pgClient_1.default.query(query, values);
        return result.rows[0] || null;
    }
    async delete(id) {
        const query = 'DELETE FROM defects WHERE id = $1';
        const result = await pgClient_1.default.query(query, [id]);
        return (result.rowCount || 0) > 0;
    }
    async findById(id) {
        const query = 'SELECT * FROM defects WHERE id = $1';
        const result = await pgClient_1.default.query(query, [id]);
        return result.rows[0] || null;
    }
    async findWithPagination(params) {
        let whereClause = 'WHERE 1=1';
        const values = [];
        let valueIndex = 1;
        if (params.status) {
            whereClause += ` AND status = $${valueIndex++}`;
            values.push(params.status);
        }
        if (params.priority) {
            whereClause += ` AND priority = $${valueIndex++}`;
            values.push(params.priority);
        }
        if (params.assignee) {
            whereClause += ` AND assignee = $${valueIndex++}`;
            values.push(params.assignee);
        }
        // 총 개수 조회
        const countQuery = `SELECT COUNT(*) FROM defects ${whereClause}`;
        const countResult = await pgClient_1.default.query(countQuery, values);
        const total = parseInt(countResult.rows[0].count);
        // 페이지네이션된 데이터 조회
        const offset = params.page * params.size;
        const dataQuery = `
            SELECT * FROM defects 
            ${whereClause}
            ORDER BY created_at DESC
            LIMIT $${valueIndex} OFFSET $${valueIndex + 1}
        `;
        const dataResult = await pgClient_1.default.query(dataQuery, [...values, params.size, offset]);
        return {
            defects: dataResult.rows,
            total
        };
    }
}
exports.defectRepository = new DefectRepository();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy9kZWZlY3RzL3JlcG9zaXRvcmllcy9kZWZlY3RSZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHlGQUFpRTtBQVdqRSxNQUFNLGdCQUFnQjtJQUNsQixLQUFLLENBQUMsTUFBTSxDQUFDLE1BQTBCO1FBQ25DLE1BQU0sS0FBSyxHQUFHOzs7Ozs7U0FNYixDQUFDO1FBRUYsTUFBTSxNQUFNLEdBQUc7WUFDWCxNQUFNLENBQUMsS0FBSztZQUNaLE1BQU0sQ0FBQyxXQUFXO1lBQ2xCLE1BQU0sQ0FBQyxNQUFNO1lBQ2IsTUFBTSxDQUFDLFFBQVE7WUFDZixNQUFNLENBQUMsUUFBUTtZQUNmLE1BQU0sQ0FBQyxRQUFRO1lBQ2YsTUFBTSxDQUFDLFNBQVM7WUFDaEIsTUFBTSxDQUFDLFVBQVU7WUFDakIsTUFBTSxDQUFDLFNBQVM7WUFDaEIsTUFBTSxDQUFDLFNBQVM7WUFDaEIsTUFBTSxDQUFDLFNBQVM7U0FDbkIsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25ELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFVLEVBQUUsT0FBd0I7UUFDN0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7YUFDakMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQzthQUMzQixHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsT0FBTyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUM7YUFDN0MsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWhCLE1BQU0sS0FBSyxH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O1NBQ1IsQ0FBQztJQUNOLENBQUM7Q0FDSjtBQUVZLFFBQUEsZ0JBQWdCLEdBQUcsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy8zaS1hMS0yMDIxLTAxNy9EZXNrdG9wL215LXByb2plY3Qvc3JjL21haW4vYXBwL2RvbWFpbnMvZGVmZWN0cy9yZXBvc2l0b3JpZXMvZGVmZWN0UmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGdDbGllbnQgZnJvbSAnLi4vLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvcGdDbGllbnQnO1xuaW1wb3J0IHsgRGVmZWN0LCBEZWZlY3RTdGF0dXMsIERlZmVjdFByaW9yaXR5IH0gZnJvbSAnLi4vbW9kZWxzL0RlZmVjdCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVmZWN0TGlzdFBhcmFtcyB7XG4gICAgcGFnZTogbnVtYmVyO1xuICAgIHNpemU6IG51bWJlcjtcbiAgICBzdGF0dXM/OiBzdHJpbmc7XG4gICAgcHJpb3JpdHk/OiBzdHJpbmc7XG4gICAgYXNzaWduZWU/OiBzdHJpbmc7XG59XG5cbmNsYXNzIERlZmVjdFJlcG9zaXRvcnkge1xuICAgIGFzeW5jIGNyZWF0ZShkZWZlY3Q6IE9taXQ8RGVmZWN0LCAnaWQnPik6IFByb21pc2U8RGVmZWN0PiB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gYFxuICAgICAgICAgICAgSU5TRVJUIElOVE8gZGVmZWN0cyAoXG4gICAgICAgICAgICAgICAgdGl0bGUsIGRlc2NyaXB0aW9uLCBzdGF0dXMsIHByaW9yaXR5LCBhc3NpZ25lZSwgcmVwb3J0ZXIsIFxuICAgICAgICAgICAgICAgIGNyZWF0ZWRfYnksIHRlc3RfY2FzZV9pZCwgcmVsZWFzZV9pZCwgY3JlYXRlZF9hdCwgdXBkYXRlZF9hdFxuICAgICAgICAgICAgKSBWQUxVRVMgKCQxLCAkMiwgJDMsICQ0LCAkNSwgJDYsICQ3LCAkOCwgJDksICQxMCwgJDExKVxuICAgICAgICAgICAgUkVUVVJOSU5HICpcbiAgICAgICAgYDtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IFtcbiAgICAgICAgICAgIGRlZmVjdC50aXRsZSxcbiAgICAgICAgICAgIGRlZmVjdC5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgIGRlZmVjdC5zdGF0dXMsXG4gICAgICAgICAgICBkZWZlY3QucHJpb3JpdHksXG4gICAgICAgICAgICBkZWZlY3QuYXNzaWduZWUsXG4gICAgICAgICAgICBkZWZlY3QucmVwb3J0ZXIsXG4gICAgICAgICAgICBkZWZlY3QuY3JlYXRlZEJ5LFxuICAgICAgICAgICAgZGVmZWN0LnRlc3RDYXNlSWQsXG4gICAgICAgICAgICBkZWZlY3QucmVsZWFzZUlkLFxuICAgICAgICAgICAgZGVmZWN0LmNyZWF0ZWRBdCxcbiAgICAgICAgICAgIGRlZmVjdC51cGRhdGVkQXRcbiAgICAgICAgXTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KHF1ZXJ5LCB2YWx1ZXMpO1xuICAgICAgICByZXR1cm4gcmVzdWx0LnJvd3NbMF07XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlKGlkOiBudW1iZXIsIHVwZGF0ZXM6IFBhcnRpYWw8RGVmZWN0Pik6IFByb21pc2U8RGVmZWN0IHwgbnVsbD4ge1xuICAgICAgICBjb25zdCBzZXRDbGF1c2UgPSBPYmplY3Qua2V5cyh1cGRhdGVzKVxuICAgICAgICAgICAgLmZpbHRlcihrZXkgPT4ga2V5ICE9PSAnaWQnKVxuICAgICAgICAgICAgLm1hcCgoa2V5LCBpbmRleCkgPT4gYCR7a2V5fSA9ICQke2luZGV4ICsgMn1gKVxuICAgICAgICAgICAgLmpvaW4oJywgJyk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBxdWVyeSA9IGBcbiAgICAgICAgICAgIFVQREFURSBkZWZlY3RzIFxuICAgICAgICAgICAgU0VUICR7c2V0Q2xhdXNlfVxuICAgICAgICAgICAgV0hFUkUgaWQgPSAkMVxuICAgICAgICAgICAgUkVUVVJOSU5HICpcbiAgICAgICAgYDtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IFtpZCwgLi4uT2JqZWN0LnZhbHVlcyh1cGRhdGVzKS5maWx0ZXIodmFsID0+IHZhbCAhPT0gdW5kZWZpbmVkKV07XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KHF1ZXJ5LCB2YWx1ZXMpO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5yb3dzWzBdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgZGVsZXRlKGlkOiBudW1iZXIpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgcXVlcnkgPSAnREVMRVRFIEZST00gZGVmZWN0cyBXSEVSRSBpZCA9ICQxJztcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkocXVlcnksIFtpZF0pO1xuICAgICAgICByZXR1cm4gKHJlc3VsdC5yb3dDb3VudCB8fCAwKSA+IDA7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZEJ5SWQoaWQ6IG51bWJlcik6IFByb21pc2U8RGVmZWN0IHwgbnVsbD4ge1xuICAgICAgICBjb25zdCBxdWVyeSA9ICdTRUxFQ1QgKiBGUk9NIGRlZmVjdHMgV0hFUkUgaWQgPSAkMSc7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KHF1ZXJ5LCBbaWRdKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5yb3dzWzBdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZFdpdGhQYWdpbmF0aW9uKHBhcmFtczogRGVmZWN0TGlzdFBhcmFtcyk6IFByb21pc2U8e1xuICAgICAgICBkZWZlY3RzOiBEZWZlY3RbXTtcbiAgICAgICAgdG90YWw6IG51bWJlcjtcbiAgICB9PiB7XG4gICAgICAgIGxldCB3aGVyZUNsYXVzZSA9ICdXSEVSRSAxPTEnO1xuICAgICAgICBjb25zdCB2YWx1ZXM6IGFueVtdID0gW107XG4gICAgICAgIGxldCB2YWx1ZUluZGV4ID0gMTtcblxuICAgICAgICBpZiAocGFyYW1zLnN0YXR1cykge1xuICAgICAgICAgICAgd2hlcmVDbGF1c2UgKz0gYCBBTkQgc3RhdHVzID0gJCR7dmFsdWVJbmRleCsrfWA7XG4gICAgICAgICAgICB2YWx1ZXMucHVzaChwYXJhbXMuc3RhdHVzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYXJhbXMucHJpb3JpdHkpIHtcbiAgICAgICAgICAgIHdoZXJlQ2xhdXNlICs9IGAgQU5EIHByaW9yaXR5ID0gJCR7dmFsdWVJbmRleCsrfWA7XG4gICAgICAgICAgICB2YWx1ZXMucHVzaChwYXJhbXMucHJpb3JpdHkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhcmFtcy5hc3NpZ25lZSkge1xuICAgICAgICAgICAgd2hlcmVDbGF1c2UgKz0gYCBBTkQgYXNzaWduZWUgPSAkJHt2YWx1ZUluZGV4Kyt9YDtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKHBhcmFtcy5hc3NpZ25lZSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyDstJ0g6rCc7IiYIOyhsO2ajFxuICAgICAgICBjb25zdCBjb3VudFF1ZXJ5ID0gYFNFTEVDVCBDT1VOVCgqKSBGUk9NIGRlZmVjdHMgJHt3aGVyZUNsYXVzZX1gO1xuICAgICAgICBjb25zdCBjb3VudFJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGNvdW50UXVlcnksIHZhbHVlcyk7XG4gICAgICAgIGNvbnN0IHRvdGFsID0gcGFyc2VJbnQoY291bnRSZXN1bHQucm93c1swXS5jb3VudCk7XG5cbiAgICAgICAgLy8g7Y6Y7J207KeA64Sk7J207IWY65CcIOuNsOydtO2EsCDsobDtmoxcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gcGFyYW1zLnBhZ2UgKiBwYXJhbXMuc2l6ZTtcbiAgICAgICAgY29uc3QgZGF0YVF1ZXJ5ID0gYFxuICAgICAgICAgICAgU0VMRUNUICogRlJPTSBkZWZlY3RzIFxuICAgICAgICAgICAgJHt3aGVyZUNsYXVzZX1cbiAgICAgICAgICAgIE9SREVSIEJZIGNyZWF0ZWRfYXQgREVTQ1xuICAgICAgICAgICAgTElNSVQgJCR7dmFsdWVJbmRleH0gT0ZGU0VUICQke3ZhbHVlSW5kZXggKyAxfVxuICAgICAgICBgO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgZGF0YVJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGRhdGFRdWVyeSwgWy4uLnZhbHVlcywgcGFyYW1zLnNpemUsIG9mZnNldF0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRlZmVjdHM6IGRhdGFSZXN1bHQucm93cyxcbiAgICAgICAgICAgIHRvdGFsXG4gICAgICAgIH07XG4gICAgfVxufVxuXG5leHBvcnQgY29uc3QgZGVmZWN0UmVwb3NpdG9yeSA9IG5ldyBEZWZlY3RSZXBvc2l0b3J5KCk7ICJdLCJ2ZXJzaW9uIjozfQ==