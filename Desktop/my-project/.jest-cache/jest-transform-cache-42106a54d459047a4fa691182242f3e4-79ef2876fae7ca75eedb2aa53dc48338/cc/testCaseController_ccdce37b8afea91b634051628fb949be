d49fdd932718bf88244ca8a730db4177
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const testCaseService_1 = require("../services/testCaseService");
const testCaseRepository_1 = require("../repositories/testCaseRepository");
const testCaseIndexer_1 = require("../elasticsearch/testCaseIndexer");
const advancedSearchService_1 = require("../elasticsearch/advancedSearchService");
const router = (0, express_1.Router)();
router.get('/', async (req, res) => {
    const cases = await (0, testCaseRepository_1.listTestCases)();
    res.json(cases);
});
router.get('/:id', async (req, res) => {
    const tc = await (0, testCaseRepository_1.getTestCaseById)(Number(req.params.id));
    if (!tc)
        return res.status(404).json({ message: 'Not found' });
    res.json(tc);
});
router.post('/', async (req, res) => {
    const created = await (0, testCaseService_1.createTestCaseWithVersion)({ ...req.body, createdBy: req.body.createdBy });
    res.status(201).json(created);
});
router.put('/:id', async (req, res) => {
    const updated = await (0, testCaseService_1.updateTestCaseWithVersion)(Number(req.params.id), req.body, req.body.updatedBy);
    if (!updated)
        return res.status(404).json({ message: 'Not found' });
    res.json(updated);
});
router.delete('/:id', async (req, res) => {
    const ok = await (0, testCaseService_1.deleteTestCaseWithIndex)(Number(req.params.id));
    if (!ok)
        return res.status(404).json({ message: 'Not found' });
    res.status(204).send();
});
router.get('/:id/versions', async (req, res) => {
    const versions = await (0, testCaseService_1.getTestCaseVersions)(Number(req.params.id));
    res.json(versions);
});
router.post('/search', async (req, res) => {
    // req.body: Elasticsearch DSL 쿼리
    const results = await (0, testCaseIndexer_1.searchTestCases)(req.body);
    res.json(results);
});
// 고급 검색 API
router.post('/search/advanced', async (req, res) => {
    try {
        const { filters, page = 0, size = 20 } = req.body;
        const result = await (0, advancedSearchService_1.advancedSearch)(filters, page, size);
        res.json(result);
    }
    catch (error) {
        console.error('Advanced search error:', error);
        res.status(500).json({ message: '검색 중 오류가 발생했습니다.' });
    }
});
// 검색 프리셋 저장
router.post('/search/presets', async (req, res) => {
    try {
        const preset = await (0, advancedSearchService_1.saveSearchPreset)(req.body);
        res.status(201).json(preset);
    }
    catch (error) {
        console.error('Save preset error:', error);
        res.status(500).json({ message: '프리셋 저장 중 오류가 발생했습니다.' });
    }
});
// 검색 프리셋 목록 조회
router.get('/search/presets', async (req, res) => {
    try {
        const { createdBy } = req.query;
        const presets = await (0, advancedSearchService_1.getSearchPresets)(createdBy);
        res.json(presets);
    }
    catch (error) {
        console.error('Get presets error:', error);
        res.status(500).json({ message: '프리셋 조회 중 오류가 발생했습니다.' });
    }
});
// 검색 프리셋 삭제
router.delete('/search/presets/:id', async (req, res) => {
    try {
        const success = await (0, advancedSearchService_1.deleteSearchPreset)(req.params.id);
        if (success) {
            res.status(204).send();
        }
        else {
            res.status(404).json({ message: '프리셋을 찾을 수 없습니다.' });
        }
    }
    catch (error) {
        console.error('Delete preset error:', error);
        res.status(500).json({ message: '프리셋 삭제 중 오류가 발생했습니다.' });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy90ZXN0Y2FzZXMvY29udHJvbGxlcnMvdGVzdENhc2VDb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEscUNBQWlDO0FBQ2pDLGlFQUFpSjtBQUNqSiwyRUFBb0Y7QUFDcEYsc0VBQW1FO0FBQ25FLGtGQUFzSjtBQUV0SixNQUFNLE1BQU0sR0FBRyxJQUFBLGdCQUFNLEdBQUUsQ0FBQztBQUV4QixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQy9CLE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBQSxrQ0FBYSxHQUFFLENBQUM7SUFDcEMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNwQixDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDbEMsTUFBTSxFQUFFLEdBQUcsTUFBTSxJQUFBLG9DQUFlLEVBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4RCxJQUFJLENBQUMsRUFBRTtRQUFFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztJQUMvRCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2pCLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUNoQyxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUEsMkNBQXlCLEVBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsU0FBUyxF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QyxDQUFDLENBQUM7QUFFSCxZQUFZO0FBQ1osTUFBTSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ3BELElBQUksQ0FBQztRQUNELE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBQSwwQ0FBa0IsRUFBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELElBQUksT0FBTyxFQUFFLENBQUM7WUFDVixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNCLENBQUM7YUFBTSxDQUFDO1lBQ0osR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0MsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDO0lBQzlELENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILGtCQUFlLE1BQU0sQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvM2ktYTEtMjAyMS0wMTcvRGVza3RvcC9teS1wcm9qZWN0L3NyYy9tYWluL2FwcC9kb21haW5zL3Rlc3RjYXNlcy9jb250cm9sbGVycy90ZXN0Q2FzZUNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBjcmVhdGVUZXN0Q2FzZVdpdGhWZXJzaW9uLCB1cGRhdGVUZXN0Q2FzZVdpdGhWZXJzaW9uLCBkZWxldGVUZXN0Q2FzZVdpdGhJbmRleCwgZ2V0VGVzdENhc2VWZXJzaW9ucyB9IGZyb20gJy4uL3NlcnZpY2VzL3Rlc3RDYXNlU2VydmljZSc7XG5pbXBvcnQgeyBsaXN0VGVzdENhc2VzLCBnZXRUZXN0Q2FzZUJ5SWQgfSBmcm9tICcuLi9yZXBvc2l0b3JpZXMvdGVzdENhc2VSZXBvc2l0b3J5JztcbmltcG9ydCB7IHNlYXJjaFRlc3RDYXNlcyB9IGZyb20gJy4uL2VsYXN0aWNzZWFyY2gvdGVzdENhc2VJbmRleGVyJztcbmltcG9ydCB7IGFkdmFuY2VkU2VhcmNoLCBzYXZlU2VhcmNoUHJlc2V0LCBnZXRTZWFyY2hQcmVzZXRzLCBkZWxldGVTZWFyY2hQcmVzZXQsIEFkdmFuY2VkU2VhcmNoRmlsdGVyIH0gZnJvbSAnLi4vZWxhc3RpY3NlYXJjaC9hZHZhbmNlZFNlYXJjaFNlcnZpY2UnO1xuXG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxucm91dGVyLmdldCgnLycsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIGNvbnN0IGNhc2VzID0gYXdhaXQgbGlzdFRlc3RDYXNlcygpO1xuICAgIHJlcy5qc29uKGNhc2VzKTtcbn0pO1xuXG5yb3V0ZXIuZ2V0KCcvOmlkJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdGMgPSBhd2FpdCBnZXRUZXN0Q2FzZUJ5SWQoTnVtYmVyKHJlcS5wYXJhbXMuaWQpKTtcbiAgICBpZiAoIXRjKSByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBtZXNzYWdlOiAnTm90IGZvdW5kJyB9KTtcbiAgICByZXMuanNvbih0Yyk7XG59KTtcblxucm91dGVyLnBvc3QoJy8nLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCBjcmVhdGVkID0gYXdhaXQgY3JlYXRlVGVzdENhc2VXaXRoVmVyc2lvbih7IC4uLnJlcS5ib2R5LCBjcmVhdGVkQnk6IHJlcS5ib2R5LmNyZWF0ZWRCeSB9KTtcbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihjcmVhdGVkKTtcbn0pO1xuXG5yb3V0ZXIucHV0KCcvOmlkJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHVwZGF0ZVRlc3RDYXNlV2l0aFZlcnNpb24oTnVtYmVyKHJlcS5wYXJhbXMuaWQpLCByZXEuYm9keSwgcmVxLmJvZHkudXBkYXRlZEJ5KTtcbiAgICBpZiAoIXVwZGF0ZWQpIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6ICdOb3QgZm91bmQnIH0pO1xuICAgIHJlcy5qc29uKHVwZGF0ZWQpO1xufSk7XG5cbnJvdXRlci5kZWxldGUoJy86aWQnLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBjb25zdCBvayA9IGF3YWl0IGRlbGV0ZVRlc3RDYXNlV2l0aEluZGV4KE51bWJlcihyZXEucGFyYW1zLmlkKSk7XG4gICAgaWYgKCFvaykgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ05vdCBmb3VuZCcgfSk7XG4gICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbn0pO1xuXG5yb3V0ZXIuZ2V0KCcvOmlkL3ZlcnNpb25zJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgY29uc3QgdmVyc2lvbnMgPSBhd2FpdCBnZXRUZXN0Q2FzZVZlcnNpb25zKE51bWJlcihyZXEucGFyYW1zLmlkKSk7XG4gICAgcmVzLmpzb24odmVyc2lvbnMpO1xufSk7XG5cbnJvdXRlci5wb3N0KCcvc2VhcmNoJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgLy8gcmVxLmJvZHk6IEVsYXN0aWNzZWFyY2ggRFNMIOy/vOumrFxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBzZWFyY2hUZXN0Q2FzZXMocmVxLmJvZHkpO1xuICAgIHJlcy5qc29uKHJlc3VsdHMpO1xufSk7XG5cbi8vIOqzoOq4iSDqsoDsg4kgQVBJXG5yb3V0ZXIucG9zdCgnL3NlYXJjaC9hZHZhbmNlZCcsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgZmlsdGVycywgcGFnZSA9IDAsIHNpemUgPSAyMCB9ID0gcmVxLmJvZHk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGFkdmFuY2VkU2VhcmNoKGZpbHRlcnMgYXMgQWR2YW5jZWRTZWFyY2hGaWx0ZXIsIHBhZ2UsIHNpemUpO1xuICAgICAgICByZXMuanNvbihyZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0FkdmFuY2VkIHNlYXJjaCBlcnJvcjonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ+qygOyDiSDspJEg7Jik66WY6rCAIOuwnOyDne2WiOyKteuLiOuLpC4nIH0pO1xuICAgIH1cbn0pO1xuXG4vLyDqsoDsg4kg7ZSE66as7IWLIOyggOyepVxucm91dGVyLnBvc3QoJy9zZWFyY2gvcHJlc2V0cycsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHByZXNldCA9IGF3YWl0IHNhdmVTZWFyY2hQcmVzZXQocmVxLmJvZHkpO1xuICAgICAgICByZXMuc3RhdHVzKDIwMSkuanNvbihwcmVzZXQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1NhdmUgcHJlc2V0IGVycm9yOicsIGVycm9yKTtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiAn7ZSE66as7IWLIOyggOyepSDspJEg7Jik66WY6rCAIOuwnOyDne2WiOyKteuLiOuLpC4nIH0pO1xuICAgIH1cbn0pO1xuXG4vLyDqsoDsg4kg7ZSE66as7IWLIOuqqeuhnSDsobDtmoxcbnJvdXRlci5nZXQoJy9zZWFyY2gvcHJlc2V0cycsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgY3JlYXRlZEJ5IH0gPSByZXEucXVlcnk7XG4gICAgICAgIGNvbnN0IHByZXNldHMgPSBhd2FpdCBnZXRTZWFyY2hQcmVzZXRzKGNyZWF0ZWRCeSBhcyBzdHJpbmcpO1xuICAgICAgICByZXMuanNvbihwcmVzZXRzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdHZXQgcHJlc2V0cyBlcnJvcjonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ+2UhOumrOyFiyDsobDtmowg7KSRIOyYpOulmOqwgCDrsJzsg53tlojsirXri4jri6QuJyB9KTtcbiAgICB9XG59KTtcblxuLy8g6rKA7IOJIO2UhOumrOyFiyDsgq3soJxcbnJvdXRlci5kZWxldGUoJy9zZWFyY2gvcHJlc2V0cy86aWQnLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgZGVsZXRlU2VhcmNoUHJlc2V0KHJlcS5wYXJhbXMuaWQpO1xuICAgICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICAgICAgcmVzLnN0YXR1cygyMDQpLnNlbmQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgbWVzc2FnZTogJ+2UhOumrOyFi+ydhCDssL7snYQg7IiYIOyXhuyKteuLiOuLpC4nIH0pO1xuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRGVsZXRlIHByZXNldCBlcnJvcjonLCBlcnJvcik7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogJ+2UhOumrOyFiyDsgq3soJwg7KSRIOyYpOulmOqwgCDrsJzsg53tlojsirXri4jri6QuJyB9KTtcbiAgICB9XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcm91dGVyOyAiXSwidmVyc2lvbiI6M30=