5ebc67e3ddeb658ef17415b698211892
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildAdvancedQuery = buildAdvancedQuery;
exports.advancedSearch = advancedSearch;
exports.saveSearchPreset = saveSearchPreset;
exports.getSearchPresets = getSearchPresets;
exports.deleteSearchPreset = deleteSearchPreset;
const esClient_1 = __importDefault(require("../../../infrastructure/elasticsearch/esClient"));
const INDEX = 'testcases';
/**
 * 복합 조건을 Elasticsearch 쿼리로 변환
 */
function buildAdvancedQuery(filters, page = 0, size = 20) {
    const must = [];
    const should = [];
    const filter = [];
    // 키워드 검색 (제목, 설명, 스텝에서 검색)
    if (filters.keyword) {
        should.push({ match: { title: { query: filters.keyword, boost: 3 } } }, { match: { prereq: { query: filters.keyword, boost: 2 } } }, { match: { steps: { query: filters.keyword, boost: 1 } } }, { match: { expected: { query: filters.keyword, boost: 1 } } });
    }
    // 폴더 필터
    if (filters.folders && filters.folders.length > 0) {
        filter.push({ terms: { folder: filters.folders } });
    }
    // 태그 필터
    if (filters.tags && filters.tags.length > 0) {
        filter.push({ terms: { tags: filters.tags } });
    }
    // 상태 필터
    if (filters.status && filters.status.length > 0) {
        filter.push({ terms: { status: filters.status } });
    }
    // 작성자 필터
    if (filters.createdBy && filters.createdBy.length > 0) {
        filter.push({ terms: { createdBy: filters.createdBy } });
    }
    // 우선순위 필터
    if (filters.priority && filters.priority.length > 0) {
        filter.push({ terms: { priority: filters.priority } });
    }
    // 날짜 범위 필터
    if (filters.dateRange) {
        const range = {};
        if (filters.dateRange.from)
            range.gte = filters.dateRange.from;
        if (filters.dateRange.to)
            range.lte = filters.dateRange.to;
        if (Object.keys(range).length > 0) {
            filter.push({ range: { createdAt: range } });
        }
    }
    const query = {
        bool: {
            must,
            should,
            filter,
            minimum_should_match: filters.keyword ? 1 : 0
        }
    };
    return {
        query,
        highlight: {
            fields: {
                title: {},
                prereq: {},
                steps: {},
                expected: {}
            },
            pre_tags: ['<mark>'],
            post_tags: ['</mark>']
        },
        from: page * size,
        size,
        sort: [
            '_score:desc',
            'createdAt:desc'
        ]
    };
}
/**
 * 고급 검색 실행
 */
async function advancedSearch(filters, page = 0, size = 20) {
    const query = buildAdvancedQuery(filters, page, size);
    const result = await esClient_1.default.search({
        index: INDEX,
        ...query
    });
    const testCases = result.hits.hits.map((hit) => hit._source);
    const highlights = {};
    result.hits.hits.forEach((hit) => {
        if (hit.highlight) {
            highlights[hit._id] = Object.values(hit.highlight).flat();
        }
    });
    return {
        testCases,
        total: typeof result.hits.total === 'number' ? result.hits.total : result.hits.total?.value || 0,
        highlights
    };
}
/**
 * 검색 프리셋 저장
 */
async function saveSearchPreset(preset) {
    const id = `preset_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const newPreset = {
        ...preset,
        id,
        createdAt: new Date().toISOString()
    };
    await esClient_1.default.index({
        index: 'search_presets',
        id,
        document: newPreset
    });
    return newPreset;
}
/**
 * 검색 프리셋 목록 조회
 */
async function getSearchPresets(createdBy) {
    const query = {
        query: {
            match_all: {}
        },
        sort: [{ createdAt: { order: 'desc' } }]
    };
    if (createdBy) {
        query.query = { term: { createdBy } };
    }
    const result = await esClient_1.default.search({
        index: 'search_presets',
        ...query
    });
    return result.hits.hits.map((hit) => hit._source);
}
/**
 * 검색 프리셋 삭제
 */
async function deleteSearchPreset(id) {
    try {
        await esClient_1.default.delete({
            index: 'search_presets',
            id
        });
        return true;
    }
    catch (error) {
        console.error('Failed to delete search preset:', error);
        return false;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy90ZXN0Y2FzZXMvZWxhc3RpY3NlYXJjaC9hZHZhbmNlZFNlYXJjaFNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFtQ0EsZ0RBOEVDO0FBS0Qsd0NBMEJDO0FBS0QsNENBZUM7QUFLRCw0Q0FrQkM7QUFLRCxnREFXQztBQTNNRCw4RkFBc0U7QUFHdEUsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDO0FBNkIxQjs7R0FFRztBQUNILFNBQWdCLGtCQUFrQixDQUFDLE9BQTZCLEVBQUUsT0FBZSxDQUFDLEVBQUUsT0FBZSxFQUFFO0lBQ25HLE1BQU0sSUFBSSxHQUFVLEVBQUUsQ0FBQztJQUN2QixNQUFNLE1BQU0sR0FBVSxFQUFFLENBQUM7SUFDekIsTUFBTSxNQUFNLEdBQVUsRUFBRSxDQUFDO0lBRXpCLDJCQUEyQjtJQUMzQixJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNwQixNQUFNLENBQUMsSUFBSSxDQUNULEVBQUUsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFDMUQsRUFBRSxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUMzRCxFQUFFLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQzFELEVBQUUsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FDOUQsQ0FBQztJQUNKLENBQUM7SUFFRCxRQUFRO0lBQ1IsSUFBSSxPQUFPLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsUUFBUTtJQUNSLElBQUksT0FBTyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUM1QyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELFFBQVE7SUFDUixJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxTQUFTO0lBQ1QsSUFBSSxPQUFPLENBQUMsU0FBUyxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3RELE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsVUFBVTtJQUNWLElBQUksT0FBTyxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUNwRCxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxR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LGtCQUFrQixDQUFDLEVBQVU7SUFDakQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxrQkFBUSxDQUFDLE1BQU0sQ0FBQztZQUNwQixLQUFLLEVBQUUsZ0JBQWdCO1lBQ3ZCLEVBQUU7U0FDSCxDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4RCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy8zaS1hMS0yMDIxLTAxNy9EZXNrdG9wL215LXByb2plY3Qvc3JjL21haW4vYXBwL2RvbWFpbnMvdGVzdGNhc2VzL2VsYXN0aWNzZWFyY2gvYWR2YW5jZWRTZWFyY2hTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBlc0NsaWVudCBmcm9tICcuLi8uLi8uLi9pbmZyYXN0cnVjdHVyZS9lbGFzdGljc2VhcmNoL2VzQ2xpZW50JztcbmltcG9ydCB7IFRlc3RDYXNlIH0gZnJvbSAnLi4vbW9kZWxzL1Rlc3RDYXNlJztcblxuY29uc3QgSU5ERVggPSAndGVzdGNhc2VzJztcblxuZXhwb3J0IGludGVyZmFjZSBBZHZhbmNlZFNlYXJjaEZpbHRlciB7XG4gIGZvbGRlcnM/OiBzdHJpbmdbXTtcbiAgdGFncz86IHN0cmluZ1tdO1xuICBzdGF0dXM/OiAoJ0FjdGl2ZScgfCAnQXJjaGl2ZWQnKVtdO1xuICBjcmVhdGVkQnk/OiBzdHJpbmdbXTtcbiAgcHJpb3JpdHk/OiAoJ0hpZ2gnIHwgJ01lZGl1bScgfCAnTG93JylbXTtcbiAgZGF0ZVJhbmdlPzoge1xuICAgIGZyb206IHN0cmluZztcbiAgICB0bzogc3RyaW5nO1xuICB9O1xuICBrZXl3b3JkPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlYXJjaFByZXNldCB7XG4gIGlkOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZztcbiAgZmlsdGVyczogQWR2YW5jZWRTZWFyY2hGaWx0ZXI7XG4gIGNyZWF0ZWRCeTogc3RyaW5nO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZWFyY2hSZXN1bHQge1xuICB0ZXN0Q2FzZXM6IFRlc3RDYXNlW107XG4gIHRvdGFsOiBudW1iZXI7XG4gIGhpZ2hsaWdodHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPjtcbn1cblxuLyoqXG4gKiDrs7Xtlakg7KGw6rG07J2EIEVsYXN0aWNzZWFyY2gg7L+866as66GcIOuzgO2ZmFxuICovXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRBZHZhbmNlZFF1ZXJ5KGZpbHRlcnM6IEFkdmFuY2VkU2VhcmNoRmlsdGVyLCBwYWdlOiBudW1iZXIgPSAwLCBzaXplOiBudW1iZXIgPSAyMCkge1xuICBjb25zdCBtdXN0OiBhbnlbXSA9IFtdO1xuICBjb25zdCBzaG91bGQ6IGFueVtdID0gW107XG4gIGNvbnN0IGZpbHRlcjogYW55W10gPSBbXTtcblxuICAvLyDtgqTsm4zrk5wg6rKA7IOJICjsoJzrqqksIOyEpOuqhSwg7Iqk7YWd7JeQ7IScIOqygOyDiSlcbiAgaWYgKGZpbHRlcnMua2V5d29yZCkge1xuICAgIHNob3VsZC5wdXNoKFxuICAgICAgeyBtYXRjaDogeyB0aXRsZTogeyBxdWVyeTogZmlsdGVycy5rZXl3b3JkLCBib29zdDogMyB9IH0gfSxcbiAgICAgIHsgbWF0Y2g6IHsgcHJlcmVxOiB7IHF1ZXJ5OiBmaWx0ZXJzLmtleXdvcmQsIGJvb3N0OiAyIH0gfSB9LFxuICAgICAgeyBtYXRjaDogeyBzdGVwczogeyBxdWVyeTogZmlsdGVycy5rZXl3b3JkLCBib29zdDogMSB9IH0gfSxcbiAgICAgIHsgbWF0Y2g6IHsgZXhwZWN0ZWQ6IHsgcXVlcnk6IGZpbHRlcnMua2V5d29yZCwgYm9vc3Q6IDEgfSB9IH1cbiAgICApO1xuICB9XG5cbiAgLy8g7Y+0642UIO2VhO2EsFxuICBpZiAoZmlsdGVycy5mb2xkZXJzICYmIGZpbHRlcnMuZm9sZGVycy5sZW5ndGggPiAwKSB7XG4gICAgZmlsdGVyLnB1c2goeyB0ZXJtczogeyBmb2xkZXI6IGZpbHRlcnMuZm9sZGVycyB9IH0pO1xuICB9XG5cbiAgLy8g7YOc6re4IO2VhO2EsFxuICBpZiAoZmlsdGVycy50YWdzICYmIGZpbHRlcnMudGFncy5sZW5ndGggPiAwKSB7XG4gICAgZmlsdGVyLnB1c2goeyB0ZXJtczogeyB0YWdzOiBmaWx0ZXJzLnRhZ3MgfSB9KTtcbiAgfVxuXG4gIC8vIOyDge2DnCDtlYTthLBcbiAgaWYgKGZpbHRlcnMuc3RhdHVzICYmIGZpbHRlcnMuc3RhdHVzLmxlbmd0aCA+IDApIHtcbiAgICBmaWx0ZXIucHVzaCh7IHRlcm1zOiB7IHN0YXR1czogZmlsdGVycy5zdGF0dXMgfSB9KTtcbiAgfVxuXG4gIC8vIOyekeyEseyekCDtlYTthLBcbiAgaWYgKGZpbHRlcnMuY3JlYXRlZEJ5ICYmIGZpbHRlcnMuY3JlYXRlZEJ5Lmxlbmd0aCA+IDApIHtcbiAgICBmaWx0ZXIucHVzaCh7IHRlcm1zOiB7IGNyZWF0ZWRCeTogZmlsdGVycy5jcmVhdGVkQnkgfSB9KTtcbiAgfVxuXG4gIC8vIOyasOyEoOyInOychCDtlYTthLBcbiAgaWYgKGZpbHRlcnMucHJpb3JpdHkgJiYgZmlsdGVycy5wcmlvcml0eS5sZW5ndGggPiAwKSB7XG4gICAgZmlsdGVyLnB1c2goeyB0ZXJtczogeyBwcmlvcml0eTogZmlsdGVycy5wcmlvcml0eSB9IH0pO1xuICB9XG5cbiAgLy8g64Kg7KecIOuylOychCDtlYTthLBcbiAgaWYgKGZpbHRlcnMuZGF0ZVJhbmdlKSB7XG4gICAgY29uc3QgcmFuZ2U6IGFueSA9IHt9O1xuICAgIGlmIChmaWx0ZXJzLmRhdGVSYW5nZS5mcm9tKSByYW5nZS5ndGUgPSBmaWx0ZXJzLmRhdGVSYW5nZS5mcm9tO1xuICAgIGlmIChmaWx0ZXJzLmRhdGVSYW5nZS50bykgcmFuZ2UubHRlID0gZmlsdGVycy5kYXRlUmFuZ2UudG87XG4gICAgaWYgKE9iamVjdC5rZXlzKHJhbmdlKS5sZW5ndGggPiAwKSB7XG4gICAgICBmaWx0ZXIucHVzaCh7IHJhbmdlOiB7IGNyZWF0ZWRBdDogcmFuZ2UgfSB9KTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBxdWVyeTogYW55ID0ge1xuICAgIGJvb2w6IHtcbiAgICAgIG11c3QsXG4gICAgICBzaG91bGQsXG4gICAgICBmaWx0ZXIsXG4gICAgICBtaW5pbXVtX3Nob3VsZF9tYXRjaDogZmlsdGVycy5rZXl3b3JkID8gMSA6IDBcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBxdWVyeSxcbiAgICBoaWdobGlnaHQ6IHtcbiAgICAgIGZpZWxkczoge1xuICAgICAgICB0aXRsZToge30sXG4gICAgICAgIHByZXJlcToge30sXG4gICAgICAgIHN0ZXBzOiB7fSxcbiAgICAgICAgZXhwZWN0ZWQ6IHt9XG4gICAgICB9LFxuICAgICAgcHJlX3RhZ3M6IFsnPG1hcms+J10sXG4gICAgICBwb3N0X3RhZ3M6IFsnPC9tYXJrPiddXG4gICAgfSxcbiAgICBmcm9tOiBwYWdlICogc2l6ZSxcbiAgICBzaXplLFxuICAgIHNvcnQ6IFtcbiAgICAgICdfc2NvcmU6ZGVzYycsXG4gICAgICAnY3JlYXRlZEF0OmRlc2MnXG4gICAgXVxuICB9O1xufVxuXG4vKipcbiAqIOqzoOq4iSDqsoDsg4kg7Iuk7ZaJXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZHZhbmNlZFNlYXJjaChcbiAgZmlsdGVyczogQWR2YW5jZWRTZWFyY2hGaWx0ZXIsXG4gIHBhZ2U6IG51bWJlciA9IDAsXG4gIHNpemU6IG51bWJlciA9IDIwXG4pOiBQcm9taXNlPFNlYXJjaFJlc3VsdD4ge1xuICBjb25zdCBxdWVyeSA9IGJ1aWxkQWR2YW5jZWRRdWVyeShmaWx0ZXJzLCBwYWdlLCBzaXplKTtcbiAgXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGVzQ2xpZW50LnNlYXJjaCh7XG4gICAgaW5kZXg6IElOREVYLFxuICAgIC4uLnF1ZXJ5XG4gIH0pO1xuXG4gIGNvbnN0IHRlc3RDYXNlcyA9IHJlc3VsdC5oaXRzLmhpdHMubWFwKChoaXQ6IGFueSkgPT4gaGl0Ll9zb3VyY2UgYXMgVGVzdENhc2UpO1xuICBjb25zdCBoaWdobGlnaHRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmdbXT4gPSB7fTtcbiAgXG4gIHJlc3VsdC5oaXRzLmhpdHMuZm9yRWFjaCgoaGl0OiBhbnkpID0+IHtcbiAgICBpZiAoaGl0LmhpZ2hsaWdodCkge1xuICAgICAgaGlnaGxpZ2h0c1toaXQuX2lkXSA9IE9iamVjdC52YWx1ZXMoaGl0LmhpZ2hsaWdodCkuZmxhdCgpIGFzIHN0cmluZ1tdO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICB0ZXN0Q2FzZXMsXG4gICAgdG90YWw6IHR5cGVvZiByZXN1bHQuaGl0cy50b3RhbCA9PT0gJ251bWJlcicgPyByZXN1bHQuaGl0cy50b3RhbCA6IHJlc3VsdC5oaXRzLnRvdGFsPy52YWx1ZSB8fCAwLFxuICAgIGhpZ2hsaWdodHNcbiAgfTtcbn1cblxuLyoqXG4gKiDqsoDsg4kg7ZSE66as7IWLIOyggOyepVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2F2ZVNlYXJjaFByZXNldChwcmVzZXQ6IE9taXQ8U2VhcmNoUHJlc2V0LCAnaWQnIHwgJ2NyZWF0ZWRBdCc+KTogUHJvbWlzZTxTZWFyY2hQcmVzZXQ+IHtcbiAgY29uc3QgaWQgPSBgcHJlc2V0XyR7RGF0ZS5ub3coKX1fJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YDtcbiAgY29uc3QgbmV3UHJlc2V0OiBTZWFyY2hQcmVzZXQgPSB7XG4gICAgLi4ucHJlc2V0LFxuICAgIGlkLFxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gIH07XG5cbiAgYXdhaXQgZXNDbGllbnQuaW5kZXgoe1xuICAgIGluZGV4OiAnc2VhcmNoX3ByZXNldHMnLFxuICAgIGlkLFxuICAgIGRvY3VtZW50OiBuZXdQcmVzZXRcbiAgfSk7XG5cbiAgcmV0dXJuIG5ld1ByZXNldDtcbn1cblxuLyoqXG4gKiDqsoDsg4kg7ZSE66as7IWLIOuqqeuhnSDsobDtmoxcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNlYXJjaFByZXNldHMoY3JlYXRlZEJ5Pzogc3RyaW5nKTogUHJvbWlzZTxTZWFyY2hQcmVzZXRbXT4ge1xuICBjb25zdCBxdWVyeTogYW55ID0ge1xuICAgIHF1ZXJ5OiB7XG4gICAgICBtYXRjaF9hbGw6IHt9XG4gICAgfSxcbiAgICBzb3J0OiBbeyBjcmVhdGVkQXQ6IHsgb3JkZXI6ICdkZXNjJyB9IH1dXG4gIH07XG5cbiAgaWYgKGNyZWF0ZWRCeSkge1xuICAgIHF1ZXJ5LnF1ZXJ5ID0geyB0ZXJtOiB7IGNyZWF0ZWRCeSB9IH07XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBlc0NsaWVudC5zZWFyY2goe1xuICAgIGluZGV4OiAnc2VhcmNoX3ByZXNldHMnLFxuICAgIC4uLnF1ZXJ5XG4gIH0pO1xuXG4gIHJldHVybiByZXN1bHQuaGl0cy5oaXRzLm1hcCgoaGl0OiBhbnkpID0+IGhpdC5fc291cmNlIGFzIFNlYXJjaFByZXNldCk7XG59XG5cbi8qKlxuICog6rKA7IOJIO2UhOumrOyFiyDsgq3soJxcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVNlYXJjaFByZXNldChpZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXNDbGllbnQuZGVsZXRlKHtcbiAgICAgIGluZGV4OiAnc2VhcmNoX3ByZXNldHMnLFxuICAgICAgaWRcbiAgICB9KTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gZGVsZXRlIHNlYXJjaCBwcmVzZXQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufSAiXSwidmVyc2lvbiI6M30=