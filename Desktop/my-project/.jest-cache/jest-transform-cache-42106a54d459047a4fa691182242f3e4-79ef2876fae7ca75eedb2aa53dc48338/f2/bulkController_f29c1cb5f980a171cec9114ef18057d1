cdfe35972e8eac8381628156d03e79a3
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.bulkUpdateStatus = exports.bulkDelete = exports.bulkCopy = exports.bulkMove = void 0;
const pgClient_1 = __importDefault(require("../infrastructure/database/pgClient"));
const bulkMove = async (req, res) => {
    try {
        const { ids, type, targetFolderId } = req.body;
        if (!ids || ids.length === 0) {
            return res.status(400).json({ error: '선택된 항목이 없습니다.' });
        }
        if (!targetFolderId) {
            return res.status(400).json({ error: '대상 폴더가 지정되지 않았습니다.' });
        }
        try {
            await pgClient_1.default.query('BEGIN');
            if (type === 'testcase') {
                const updateQuery = `
          UPDATE testcases 
          SET folder_id = $1, updated_at = NOW() 
          WHERE id = ANY($2)
        `;
                await pgClient_1.default.query(updateQuery, [targetFolderId, ids]);
            }
            else if (type === 'folder') {
                const updateQuery = `
          UPDATE folders 
          SET parent_id = $1, updated_at = NOW() 
          WHERE id = ANY($2)
        `;
                await pgClient_1.default.query(updateQuery, [targetFolderId, ids]);
            }
            await pgClient_1.default.query('COMMIT');
            res.json({
                success: true,
                message: `${ids.length}개 항목이 이동되었습니다.`,
                movedCount: ids.length
            });
        }
        catch (error) {
            await pgClient_1.default.query('ROLLBACK');
            throw error;
        }
    }
    catch (error) {
        console.error('일괄 이동 오류:', error);
        res.status(500).json({ error: '일괄 이동 중 오류가 발생했습니다.' });
    }
};
exports.bulkMove = bulkMove;
const bulkCopy = async (req, res) => {
    try {
        const { ids, type, targetFolderId } = req.body;
        if (!ids || ids.length === 0) {
            return res.status(400).json({ error: '선택된 항목이 없습니다.' });
        }
        if (!targetFolderId) {
            return res.status(400).json({ error: '대상 폴더가 지정되지 않았습니다.' });
        }
        try {
            await pgClient_1.default.query('BEGIN');
            if (type === 'testcase') {
                // 테스트 케이스 복사
                const selectQuery = `
          SELECT title, description, steps, expected_result, priority, tags, status
          FROM testcases WHERE id = ANY($1)
        `;
                const { rows } = await pgClient_1.default.query(selectQuery, [ids]);
                for (const row of rows) {
                    const insertQuery = `
            INSERT INTO testcases (title, description, steps, expected_result, priority, tags, status, folder_id, created_at, updated_at)
            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW(), NOW())
          `;
                    await pgClient_1.default.query(insertQuery, [
                        row.title + ' (복사본)',
                        row.description,
                        row.steps,
                        row.expected_result,
                        row.priority,
                        row.tags,
                        row.status,
                        targetFolderId
                    ]);
                }
            }
            else if (type === 'folder') {
                // 폴더 복사 (재귀적 복사 로직 필요)
                const selectQuery = `
          SELECT name, description, parent_id
          FROM folders WHERE id = ANY($1)
        `;
                const { rows } = await pgClient_1.default.query(selectQuery, [ids]);
                for (const row of rows) {
                    const insertQuery = `
            INSERT INTO folders (name, description, parent_id, created_at, updated_at)
            VALUES ($1, $2, $3, NOW(), NOW())
          `;
                    await pgClient_1.default.query(insertQuery, [
                        row.name + ' (복사본)',
                        row.description,
                        targetFolderId
                    ]);
                }
            }
            await pgClient_1.default.query('COMMIT');
            res.json({
                success: true,
                message: `${ids.length}개 항목이 복사되었습니다.`,
                copiedCount: ids.length
            });
        }
        catch (error) {
            await pgClient_1.default.query('ROLLBACK');
            throw error;
        }
    }
    catch (error) {
        console.error('일괄 복사 오류:', error);
        res.status(500).json({ error: '일괄 복사 중 오류가 발생했습니다.' });
    }
};
exports.bulkCopy = bulkCopy;
const bulkDelete = async (req, res) => {
    try {
        const { ids, type } = req.body;
        if (!ids || ids.length === 0) {
            return res.status(400).json({ error: '선택된 항목이 없습니다.' });
        }
        try {
            await pgClient_1.default.query('BEGIN');
            if (type === 'testcase') {
                const deleteQuery = `DELETE FROM testcases WHERE id = ANY($1)`;
                await pgClient_1.default.query(deleteQuery, [ids]);
            }
            else if (type === 'folder') {
                // 폴더 삭제 시 하위 항목도 함께 삭제
                const deleteQuery = `DELETE FROM folders WHERE id = ANY($1)`;
                await pgClient_1.default.query(deleteQuery, [ids]);
            }
            await pgClient_1.default.query('COMMIT');
            res.json({
                success: true,
                message: `${ids.length}개 항목이 삭제되었습니다.`,
                deletedCount: ids.length
            });
        }
        catch (error) {
            await pgClient_1.default.query('ROLLBACK');
            throw error;
        }
    }
    catch (error) {
        console.error('일괄 삭제 오류:', error);
        res.status(500).json({ error: '일괄 삭제 중 오류가 발생했습니다.' });
    }
};
exports.bulkDelete = bulkDelete;
const bulkUpdateStatus = async (req, res) => {
    try {
        const { ids, newStatus } = req.body;
        if (!ids || ids.length === 0) {
            return res.status(400).json({ error: '선택된 항목이 없습니다.' });
        }
        if (!newStatus) {
            return res.status(400).json({ error: '새로운 상태가 지정되지 않았습니다.' });
        }
        try {
            await pgClient_1.default.query('BEGIN');
            const updateQuery = `
        UPDATE testcases 
        SET status = $1, updated_at = NOW() 
        WHERE id = ANY($2)
      `;
            await pgClient_1.default.query(updateQuery, [newStatus, ids]);
            await pgClient_1.default.query('COMMIT');
            res.json({
                success: true,
                message: `${ids.length}개 테스트 케이스의 상태가 변경되었습니다.`,
                updatedCount: ids.length
            });
        }
        catch (error) {
            await pgClient_1.default.query('ROLLBACK');
            throw error;
        }
    }
    catch (error) {
        console.error('일괄 상태 변경 오류:', error);
        res.status(500).json({ error: '일괄 상태 변경 중 오류가 발생했습니다.' });
    }
};
exports.bulkUpdateStatus = bulkUpdateStatus;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvY29udHJvbGxlcnMvYnVsa0NvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsbUZBQTJEO0FBU3BELE1BQU0sUUFBUSxHQUFHLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDNUQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEdBQXlCLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFckUsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzdCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBRUQsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCxJQUFJLENBQUM7WUFDSCxNQUFNLGtCQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRTlCLElBQUksSUFBSSxLQUFLLFVBQVUsRUFBRSxDQUFDO2dCQUN4QixNQUFNLFdBQVcsR0FBRzs7OztTQUluQixDQUFDO2dCQUNGLE1BQU0sa0JBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsY0FBYyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDM0QsQ0FBQztpQkFBTSxJQUFJLElBQUksS0FBSyxRQUFRLEVBQUUsQ0FBQztnQkFDN0IsTUFBTSxXQUFXLEdBQUc7Ozs7U0FJbkIsQ0FBQztnQkFDRixNQUFNLGtCQUFRLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxD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QUFRLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDckMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO0lBQzVELENBQUM7QUFDSCxDQUFDLENBQUM7QUFyQ1csUUFBQSxnQkFBZ0Isb0JBcUMzQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvM2ktYTEtMjAyMS0wMTcvRGVza3RvcC9teS1wcm9qZWN0L3NyYy9tYWluL2FwcC9jb250cm9sbGVycy9idWxrQ29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHBnQ2xpZW50IGZyb20gJy4uL2luZnJhc3RydWN0dXJlL2RhdGFiYXNlL3BnQ2xpZW50JztcblxuaW50ZXJmYWNlIEJ1bGtPcGVyYXRpb25SZXF1ZXN0IHtcbiAgaWRzOiBudW1iZXJbXTtcbiAgdHlwZTogJ3Rlc3RjYXNlJyB8ICdmb2xkZXInO1xuICB0YXJnZXRGb2xkZXJJZD86IG51bWJlcjtcbiAgbmV3U3RhdHVzPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgYnVsa01vdmUgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZHMsIHR5cGUsIHRhcmdldEZvbGRlcklkIH06IEJ1bGtPcGVyYXRpb25SZXF1ZXN0ID0gcmVxLmJvZHk7XG4gICAgXG4gICAgaWYgKCFpZHMgfHwgaWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICfshKDtg53rkJwg7ZWt66qp7J20IOyXhuyKteuLiOuLpC4nIH0pO1xuICAgIH1cbiAgICBcbiAgICBpZiAoIXRhcmdldEZvbGRlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ+uMgOyDgSDtj7TrjZTqsIAg7KeA7KCV65CY7KeAIOyViuyVmOyKteuLiOuLpC4nIH0pO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnQkVHSU4nKTtcbiAgICAgIFxuICAgICAgaWYgKHR5cGUgPT09ICd0ZXN0Y2FzZScpIHtcbiAgICAgICAgY29uc3QgdXBkYXRlUXVlcnkgPSBgXG4gICAgICAgICAgVVBEQVRFIHRlc3RjYXNlcyBcbiAgICAgICAgICBTRVQgZm9sZGVyX2lkID0gJDEsIHVwZGF0ZWRfYXQgPSBOT1coKSBcbiAgICAgICAgICBXSEVSRSBpZCA9IEFOWSgkMilcbiAgICAgICAgYDtcbiAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkodXBkYXRlUXVlcnksIFt0YXJnZXRGb2xkZXJJZCwgaWRzXSk7XG4gICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmb2xkZXInKSB7XG4gICAgICAgIGNvbnN0IHVwZGF0ZVF1ZXJ5ID0gYFxuICAgICAgICAgIFVQREFURSBmb2xkZXJzIFxuICAgICAgICAgIFNFVCBwYXJlbnRfaWQgPSAkMSwgdXBkYXRlZF9hdCA9IE5PVygpIFxuICAgICAgICAgIFdIRVJFIGlkID0gQU5ZKCQyKVxuICAgICAgICBgO1xuICAgICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSh1cGRhdGVRdWVyeSwgW3RhcmdldEZvbGRlcklkLCBpZHNdKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0NPTU1JVCcpO1xuICAgICAgXG4gICAgICByZXMuanNvbih7IFxuICAgICAgICBzdWNjZXNzOiB0cnVlLCBcbiAgICAgICAgbWVzc2FnZTogYCR7aWRzLmxlbmd0aH3qsJwg7ZWt66qp7J20IOydtOuPmeuQmOyXiOyKteuLiOuLpC5gLFxuICAgICAgICBtb3ZlZENvdW50OiBpZHMubGVuZ3RoIFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdST0xMQkFDSycpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ+ydvOq0hCDsnbTrj5kg7Jik66WYOicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAn7J286rSEIOydtOuPmSDspJEg7Jik66WY6rCAIOuwnOyDne2WiOyKteuLiOuLpC4nIH0pO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgYnVsa0NvcHkgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZHMsIHR5cGUsIHRhcmdldEZvbGRlcklkIH06IEJ1bGtPcGVyYXRpb25SZXF1ZXN0ID0gcmVxLmJvZHk7XG4gICAgXG4gICAgaWYgKCFpZHMgfHwgaWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICfshKDtg53rkJwg7ZWt66qp7J20IOyXhuyKteuLiOuLpC4nIH0pO1xuICAgIH1cbiAgICBcbiAgICBpZiAoIXRhcmdldEZvbGRlcklkKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ+uMgOyDgSDtj7TrjZTqsIAg7KeA7KCV65CY7KeAIOyViuyVmOyKteuLiOuLpC4nIH0pO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnQkVHSU4nKTtcbiAgICAgIFxuICAgICAgaWYgKHR5cGUgPT09ICd0ZXN0Y2FzZScpIHtcbiAgICAgICAgLy8g7YWM7Iqk7Yq4IOy8gOydtOyKpCDrs7XsgqxcbiAgICAgICAgY29uc3Qgc2VsZWN0UXVlcnkgPSBgXG4gICAgICAgICAgU0VMRUNUIHRpdGxlLCBkZXNjcmlwdGlvbiwgc3RlcHMsIGV4cGVjdGVkX3Jlc3VsdCwgcHJpb3JpdHksIHRhZ3MsIHN0YXR1c1xuICAgICAgICAgIEZST00gdGVzdGNhc2VzIFdIRVJFIGlkID0gQU5ZKCQxKVxuICAgICAgICBgO1xuICAgICAgICBjb25zdCB7IHJvd3MgfSA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KHNlbGVjdFF1ZXJ5LCBbaWRzXSk7XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IHJvdyBvZiByb3dzKSB7XG4gICAgICAgICAgY29uc3QgaW5zZXJ0UXVlcnkgPSBgXG4gICAgICAgICAgICBJTlNFUlQgSU5UTyB0ZXN0Y2FzZXMgKHRpdGxlLCBkZXNjcmlwdGlvbiwgc3RlcHMsIGV4cGVjdGVkX3Jlc3VsdCwgcHJpb3JpdHksIHRhZ3MsIHN0YXR1cywgZm9sZGVyX2lkLCBjcmVhdGVkX2F0LCB1cGRhdGVkX2F0KVxuICAgICAgICAgICAgVkFMVUVTICgkMSwgJDIsICQzLCAkNCwgJDUsICQ2LCAkNywgJDgsIE5PVygpLCBOT1coKSlcbiAgICAgICAgICBgO1xuICAgICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGluc2VydFF1ZXJ5LCBbXG4gICAgICAgICAgICByb3cudGl0bGUgKyAnICjrs7Xsgqzrs7gpJyxcbiAgICAgICAgICAgIHJvdy5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgIHJvdy5zdGVwcyxcbiAgICAgICAgICAgIHJvdy5leHBlY3RlZF9yZXN1bHQsXG4gICAgICAgICAgICByb3cucHJpb3JpdHksXG4gICAgICAgICAgICByb3cudGFncyxcbiAgICAgICAgICAgIHJvdy5zdGF0dXMsXG4gICAgICAgICAgICB0YXJnZXRGb2xkZXJJZFxuICAgICAgICAgIF0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdmb2xkZXInKSB7XG4gICAgICAgIC8vIO2PtOuNlCDrs7XsgqwgKOyerOq3gOyggSDrs7Xsgqwg66Gc7KeBIO2VhOyalClcbiAgICAgICAgY29uc3Qgc2VsZWN0UXVlcnkgPSBgXG4gICAgICAgICAgU0VMRUNUIG5hbWUsIGRlc2NyaXB0aW9uLCBwYXJlbnRfaWRcbiAgICAgICAgICBGUk9NIGZvbGRlcnMgV0hFUkUgaWQgPSBBTlkoJDEpXG4gICAgICAgIGA7XG4gICAgICAgIGNvbnN0IHsgcm93cyB9ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoc2VsZWN0UXVlcnksIFtpZHNdKTtcbiAgICAgICAgXG4gICAgICAgIGZvciAoY29uc3Qgcm93IG9mIHJvd3MpIHtcbiAgICAgICAgICBjb25zdCBpbnNlcnRRdWVyeSA9IGBcbiAgICAgICAgICAgIElOU0VSVCBJTlRPIGZvbGRlcnMgKG5hbWUsIGRlc2NyaXB0aW9uLCBwYXJlbnRfaWQsIGNyZWF0ZWRfYXQsIHVwZGF0ZWRfYXQpXG4gICAgICAgICAgICBWQUxVRVMgKCQxLCAkMiwgJDMsIE5PVygpLCBOT1coKSlcbiAgICAgICAgICBgO1xuICAgICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KGluc2VydFF1ZXJ5LCBbXG4gICAgICAgICAgICByb3cubmFtZSArICcgKOuzteyCrOuzuCknLFxuICAgICAgICAgICAgcm93LmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgdGFyZ2V0Rm9sZGVySWRcbiAgICAgICAgICBdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnQ09NTUlUJyk7XG4gICAgICBcbiAgICAgIHJlcy5qc29uKHsgXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsIFxuICAgICAgICBtZXNzYWdlOiBgJHtpZHMubGVuZ3RofeqwnCDtla3rqqnsnbQg67O17IKs65CY7JeI7Iq164uI64ukLmAsXG4gICAgICAgIGNvcGllZENvdW50OiBpZHMubGVuZ3RoIFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdST0xMQkFDSycpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ+ydvOq0hCDrs7Xsgqwg7Jik66WYOicsIGVycm9yKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAn7J286rSEIOuzteyCrCDspJEg7Jik66WY6rCAIOuwnOyDne2WiOyKteuLiOuLpC4nIH0pO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgYnVsa0RlbGV0ZSA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGlkcywgdHlwZSB9OiBCdWxrT3BlcmF0aW9uUmVxdWVzdCA9IHJlcS5ib2R5O1xuICAgIFxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAn7ISg7YOd65CcIO2VreuqqeydtCDsl4bsirXri4jri6QuJyB9KTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0JFR0lOJyk7XG4gICAgICBcbiAgICAgIGlmICh0eXBlID09PSAndGVzdGNhc2UnKSB7XG4gICAgICAgIGNvbnN0IGRlbGV0ZVF1ZXJ5ID0gYERFTEVURSBGUk9NIHRlc3RjYXNlcyBXSEVSRSBpZCA9IEFOWSgkMSlgO1xuICAgICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeShkZWxldGVRdWVyeSwgW2lkc10pO1xuICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZm9sZGVyJykge1xuICAgICAgICAvLyDtj7TrjZQg7IKt7KCcIOyLnCDtlZjsnIQg7ZWt66qp64+EIO2VqOq7mCDsgq3soJxcbiAgICAgICAgY29uc3QgZGVsZXRlUXVlcnkgPSBgREVMRVRFIEZST00gZm9sZGVycyBXSEVSRSBpZCA9IEFOWSgkMSlgO1xuICAgICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeShkZWxldGVRdWVyeSwgW2lkc10pO1xuICAgICAgfVxuICAgICAgXG4gICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnQ09NTUlUJyk7XG4gICAgICBcbiAgICAgIHJlcy5qc29uKHsgXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsIFxuICAgICAgICBtZXNzYWdlOiBgJHtpZHMubGVuZ3RofeqwnCDtla3rqqnsnbQg7IKt7KCc65CY7JeI7Iq164uI64ukLmAsXG4gICAgICAgIGRlbGV0ZWRDb3VudDogaWRzLmxlbmd0aCBcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnUk9MTEJBQ0snKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCfsnbzqtIQg7IKt7KCcIOyYpOulmDonLCBlcnJvcik7XG4gICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ+ydvOq0hCDsgq3soJwg7KSRIOyYpOulmOqwgCDrsJzsg53tlojsirXri4jri6QuJyB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGJ1bGtVcGRhdGVTdGF0dXMgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZHMsIG5ld1N0YXR1cyB9OiBCdWxrT3BlcmF0aW9uUmVxdWVzdCA9IHJlcS5ib2R5O1xuICAgIFxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAn7ISg7YOd65CcIO2VreuqqeydtCDsl4bsirXri4jri6QuJyB9KTtcbiAgICB9XG4gICAgXG4gICAgaWYgKCFuZXdTdGF0dXMpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAn7IOI66Gc7Jq0IOyDge2DnOqwgCDsp4DsoJXrkJjsp4Ag7JWK7JWY7Iq164uI64ukLicgfSk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdCRUdJTicpO1xuICAgICAgXG4gICAgICBjb25zdCB1cGRhdGVRdWVyeSA9IGBcbiAgICAgICAgVVBEQVRFIHRlc3RjYXNlcyBcbiAgICAgICAgU0VUIHN0YXR1cyA9ICQxLCB1cGRhdGVkX2F0ID0gTk9XKCkgXG4gICAgICAgIFdIRVJFIGlkID0gQU5ZKCQyKVxuICAgICAgYDtcbiAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KHVwZGF0ZVF1ZXJ5LCBbbmV3U3RhdHVzLCBpZHNdKTtcbiAgICAgIFxuICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0NPTU1JVCcpO1xuICAgICAgXG4gICAgICByZXMuanNvbih7IFxuICAgICAgICBzdWNjZXNzOiB0cnVlLCBcbiAgICAgICAgbWVzc2FnZTogYCR7aWRzLmxlbmd0aH3qsJwg7YWM7Iqk7Yq4IOy8gOydtOyKpOydmCDsg4Htg5zqsIAg67OA6rK965CY7JeI7Iq164uI64ukLmAsXG4gICAgICAgIHVwZGF0ZWRDb3VudDogaWRzLmxlbmd0aCBcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnUk9MTEJBQ0snKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCfsnbzqtIQg7IOB7YOcIOuzgOqyvSDsmKTrpZg6JywgZXJyb3IpO1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICfsnbzqtIQg7IOB7YOcIOuzgOqyvSDspJEg7Jik66WY6rCAIOuwnOyDne2WiOyKteuLiOuLpC4nIH0pO1xuICB9XG59OyAiXSwidmVyc2lvbiI6M30=