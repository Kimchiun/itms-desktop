64d156d5a1b259a603eb60917e813bfe
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createFolder = createFolder;
exports.getFolderById = getFolderById;
exports.getAllFolders = getAllFolders;
exports.getFolderTree = getFolderTree;
exports.getFolderTreePaginated = getFolderTreePaginated;
exports.getFolderTreeWithLazyLoading = getFolderTreeWithLazyLoading;
exports.updateFolder = updateFolder;
exports.deleteFolder = deleteFolder;
exports.getTestCasesInFolder = getTestCasesInFolder;
exports.addTestCaseToFolder = addTestCaseToFolder;
exports.removeTestCaseFromFolder = removeTestCaseFromFolder;
exports.moveTestCase = moveTestCase;
exports.moveTestCasesBatch = moveTestCasesBatch;
exports.checkCircularReference = checkCircularReference;
const pgClient_1 = __importDefault(require("../../../infrastructure/database/pgClient"));
async function createFolder(folder) {
    const result = await pgClient_1.default.query('INSERT INTO folders (name, description, parent_id, created_by) VALUES ($1, $2, $3, $4) RETURNING *', [folder.name, folder.description, folder.parentId, folder.createdBy]);
    return result.rows[0];
}
async function getFolderById(id) {
    const result = await pgClient_1.default.query('SELECT * FROM folders WHERE id = $1', [id]);
    return result.rows[0] || null;
}
async function getAllFolders() {
    const result = await pgClient_1.default.query('SELECT * FROM folders ORDER BY name');
    return result.rows;
}
async function getFolderTree() {
    // 모든 폴더 조회
    const folders = await getAllFolders();
    // 테스트 케이스 수 조회
    const testCaseCounts = await pgClient_1.default.query(`
        SELECT folder_id, COUNT(*) as count 
        FROM case_folders 
        GROUP BY folder_id
    `);
    const countMap = new Map();
    testCaseCounts.rows.forEach(row => {
        countMap.set(row.folder_id, parseInt(row.count));
    });
    // 트리 구조 생성
    const folderMap = new Map();
    const rootFolders = [];
    folders.forEach(folder => {
        const folderTree = {
            ...folder,
            children: [],
            testCaseCount: countMap.get(folder.id) || 0
        };
        folderMap.set(folder.id, folderTree);
    });
    folders.forEach(folder => {
        const folderTree = folderMap.get(folder.id);
        if (folder.parentId) {
            const parent = folderMap.get(folder.parentId);
            if (parent) {
                parent.children.push(folderTree);
            }
        }
        else {
            rootFolders.push(folderTree);
        }
    });
    return rootFolders;
}
async function getFolderTreePaginated(page = 1, limit = 100) {
    const offset = (page - 1) * limit;
    // 전체 개수 조회
    const countResult = await pgClient_1.default.query('SELECT COUNT(*) as total FROM folders');
    const total = parseInt(countResult.rows[0].total);
    // 페이징된 폴더 조회
    const result = await pgClient_1.default.query('SELECT * FROM folders ORDER BY name LIMIT $1 OFFSET $2', [limit, offset]);
    const folders = result.rows.map(row => ({
        ...row,
        children: [],
        testCaseCount: 0
    }));
    return { folders, total };
}
async function getFolderTreeWithLazyLoading(parentId) {
    const whereClause = parentId ? 'WHERE parent_id = $1' : 'WHERE parent_id IS NULL';
    const params = parentId ? [parentId] : [];
    const result = await pgClient_1.default.query(`SELECT * FROM folders ${whereClause} ORDER BY name`, params);
    return result.rows.map(row => ({
        ...row,
        children: [],
        testCaseCount: 0
    }));
}
async function updateFolder(id, updates) {
    const fields = [];
    const values = [];
    let paramIndex = 1;
    if (updates.name !== undefined) {
        fields.push(`name = $${paramIndex++}`);
        values.push(updates.name);
    }
    if (updates.description !== undefined) {
        fields.push(`description = $${paramIndex++}`);
        values.push(updates.description);
    }
    if (updates.parentId !== undefined) {
        fields.push(`parent_id = $${paramIndex++}`);
        values.push(updates.parentId);
    }
    fields.push(`updated_at = CURRENT_TIMESTAMP`);
    values.push(id);
    const result = await pgClient_1.default.query(`UPDATE folders SET ${fields.join(', ')} WHERE id = $${paramIndex} RETURNING *`, values);
    return result.rows[0] || null;
}
async function deleteFolder(id) {
    const result = await pgClient_1.default.query('DELETE FROM folders WHERE id = $1', [id]);
    return (result.rowCount ?? 0) > 0;
}
async function getTestCasesInFolder(folderId) {
    const result = await pgClient_1.default.query('SELECT testcase_id FROM case_folders WHERE folder_id = $1', [folderId]);
    return result.rows.map(row => row.testcase_id);
}
async function addTestCaseToFolder(testCaseId, folderId) {
    const result = await pgClient_1.default.query('INSERT INTO case_folders (testcase_id, folder_id) VALUES ($1, $2) ON CONFLICT DO NOTHING RETURNING id', [testCaseId, folderId]);
    if (result.rowCount === 0) {
        throw new Error('이미 해당 폴더에 포함된 테스트케이스입니다.');
    }
}
async function removeTestCaseFromFolder(testCaseId, folderId) {
    await pgClient_1.default.query('DELETE FROM case_folders WHERE testcase_id = $1 AND folder_id = $2', [testCaseId, folderId]);
}
async function moveTestCase(testCaseId, fromFolderId, toFolderId) {
    await pgClient_1.default.query('BEGIN');
    try {
        await removeTestCaseFromFolder(testCaseId, fromFolderId);
        await addTestCaseToFolder(testCaseId, toFolderId);
        await pgClient_1.default.query('COMMIT');
    }
    catch (error) {
        await pgClient_1.default.query('ROLLBACK');
        throw error;
    }
}
async function moveTestCasesBatch(testCaseIds, fromFolderId, toFolderId) {
    await pgClient_1.default.query('BEGIN');
    try {
        // 기존 관계 제거
        await pgClient_1.default.query('DELETE FROM case_folders WHERE testcase_id = ANY($1) AND folder_id = $2', [testCaseIds, fromFolderId]);
        // 새 관계 추가 (배치 처리)
        const values = testCaseIds.map((_, index) => `($${index + 1}, $${testCaseIds.length + 1})`).join(', ');
        await pgClient_1.default.query(`INSERT INTO case_folders (testcase_id, folder_id) VALUES ${values}`, [...testCaseIds, toFolderId]);
        await pgClient_1.default.query('COMMIT');
    }
    catch (error) {
        await pgClient_1.default.query('ROLLBACK');
        throw error;
    }
}
async function checkCircularReference(folderId, newParentId) {
    if (!newParentId)
        return false;
    const visited = new Set();
    let currentId = newParentId;
    while (currentId) {
        if (visited.has(currentId) || currentId === folderId) {
            return true; // 순환 참조 발견
        }
        visited.add(currentId);
        const result = await pgClient_1.default.query('SELECT parent_id FROM folders WHERE id = $1', [currentId]);
        if (result.rows.length === 0)
            break;
        currentId = result.rows[0].parent_id;
    }
    return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy9mb2xkZXJzL3JlcG9zaXRvcmllcy9mb2xkZXJSZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBR0Esb0NBTUM7QUFFRCxzQ0FHQztBQUVELHNDQUdDO0FBRUQsc0NBMENDO0FBRUQsd0RBb0JDO0FBRUQsb0VBY0M7QUFFRCxvQ0EyQkM7QUFFRCxvQ0FHQztBQUVELG9EQU1DO0FBRUQsa0RBUUM7QUFFRCw0REFLQztBQUVELG9DQVVDO0FBRUQsZ0RBcUJDO0FBRUQsd0RBc0JDO0FBM05ELHlGQUFpRTtBQUcxRCxLQUFLLFVBQVUsWUFBWSxDQUFDLE1BQXNEO0lBQ3JGLE1BQU0sTUFBTSxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxLQUFLLENBQy9CLG9HQUFvRyxFQUNwRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FDdkUsQ0FBQztJQUNGLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMxQixDQUFDO0FBRU0sS0FBSyxVQUFVLGFBQWEsQ0FBQyxFQUFVO0lBQzFDLE1BQU0sTUFBTSxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxLQUFLLENBQUMscUNBQXFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2pGLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7QUFDbEMsQ0FBQztBQUVNLEtBQUssVUFBVSxhQUFhO0lBQy9CLE1BQU0sTUFBTSxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztJQUMzRSxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDdkIsQ0FBQztBQUVNLEtBQUssVUFBVSxhQUFhO0lBQy9CLFdBQVc7SUFDWCxNQUFNLE9BQU8s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VXNlcnMvM2ktYTEtMjAyMS0wMTcvRGVza3RvcC9teS1wcm9qZWN0L3NyYy9tYWluL2FwcC9kb21haW5zL2ZvbGRlcnMvcmVwb3NpdG9yaWVzL2ZvbGRlclJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBnQ2xpZW50IGZyb20gJy4uLy4uLy4uL2luZnJhc3RydWN0dXJlL2RhdGFiYXNlL3BnQ2xpZW50JztcbmltcG9ydCB7IEZvbGRlciwgRm9sZGVyVHJlZSB9IGZyb20gJy4uL21vZGVscy9Gb2xkZXInO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlRm9sZGVyKGZvbGRlcjogT21pdDxGb2xkZXIsICdpZCcgfCAnY3JlYXRlZEF0JyB8ICd1cGRhdGVkQXQnPik6IFByb21pc2U8Rm9sZGVyPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgICdJTlNFUlQgSU5UTyBmb2xkZXJzIChuYW1lLCBkZXNjcmlwdGlvbiwgcGFyZW50X2lkLCBjcmVhdGVkX2J5KSBWQUxVRVMgKCQxLCAkMiwgJDMsICQ0KSBSRVRVUk5JTkcgKicsXG4gICAgICAgIFtmb2xkZXIubmFtZSwgZm9sZGVyLmRlc2NyaXB0aW9uLCBmb2xkZXIucGFyZW50SWQsIGZvbGRlci5jcmVhdGVkQnldXG4gICAgKTtcbiAgICByZXR1cm4gcmVzdWx0LnJvd3NbMF07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGb2xkZXJCeUlkKGlkOiBudW1iZXIpOiBQcm9taXNlPEZvbGRlciB8IG51bGw+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnU0VMRUNUICogRlJPTSBmb2xkZXJzIFdIRVJFIGlkID0gJDEnLCBbaWRdKTtcbiAgICByZXR1cm4gcmVzdWx0LnJvd3NbMF0gfHwgbnVsbDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEFsbEZvbGRlcnMoKTogUHJvbWlzZTxGb2xkZXJbXT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdTRUxFQ1QgKiBGUk9NIGZvbGRlcnMgT1JERVIgQlkgbmFtZScpO1xuICAgIHJldHVybiByZXN1bHQucm93cztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEZvbGRlclRyZWUoKTogUHJvbWlzZTxGb2xkZXJUcmVlW10+IHtcbiAgICAvLyDrqqjrk6Ag7Y+0642UIOyhsO2ajFxuICAgIGNvbnN0IGZvbGRlcnMgPSBhd2FpdCBnZXRBbGxGb2xkZXJzKCk7XG4gICAgXG4gICAgLy8g7YWM7Iqk7Yq4IOy8gOydtOyKpCDsiJgg7KGw7ZqMXG4gICAgY29uc3QgdGVzdENhc2VDb3VudHMgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShgXG4gICAgICAgIFNFTEVDVCBmb2xkZXJfaWQsIENPVU5UKCopIGFzIGNvdW50IFxuICAgICAgICBGUk9NIGNhc2VfZm9sZGVycyBcbiAgICAgICAgR1JPVVAgQlkgZm9sZGVyX2lkXG4gICAgYCk7XG4gICAgXG4gICAgY29uc3QgY291bnRNYXAgPSBuZXcgTWFwPG51bWJlciwgbnVtYmVyPigpO1xuICAgIHRlc3RDYXNlQ291bnRzLnJvd3MuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgICBjb3VudE1hcC5zZXQocm93LmZvbGRlcl9pZCwgcGFyc2VJbnQocm93LmNvdW50KSk7XG4gICAgfSk7XG4gICAgXG4gICAgLy8g7Yq466asIOq1rOyhsCDsg53shLFcbiAgICBjb25zdCBmb2xkZXJNYXAgPSBuZXcgTWFwPG51bWJlciwgRm9sZGVyVHJlZT4oKTtcbiAgICBjb25zdCByb290Rm9sZGVyczogRm9sZGVyVHJlZVtdID0gW107XG4gICAgXG4gICAgZm9sZGVycy5mb3JFYWNoKGZvbGRlciA9PiB7XG4gICAgICAgIGNvbnN0IGZvbGRlclRyZWU6IEZvbGRlclRyZWUgPSB7XG4gICAgICAgICAgICAuLi5mb2xkZXIsXG4gICAgICAgICAgICBjaGlsZHJlbjogW10sXG4gICAgICAgICAgICB0ZXN0Q2FzZUNvdW50OiBjb3VudE1hcC5nZXQoZm9sZGVyLmlkKSB8fCAwXG4gICAgICAgIH07XG4gICAgICAgIGZvbGRlck1hcC5zZXQoZm9sZGVyLmlkLCBmb2xkZXJUcmVlKTtcbiAgICB9KTtcbiAgICBcbiAgICBmb2xkZXJzLmZvckVhY2goZm9sZGVyID0+IHtcbiAgICAgICAgY29uc3QgZm9sZGVyVHJlZSA9IGZvbGRlck1hcC5nZXQoZm9sZGVyLmlkKSE7XG4gICAgICAgIGlmIChmb2xkZXIucGFyZW50SWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IGZvbGRlck1hcC5nZXQoZm9sZGVyLnBhcmVudElkKTtcbiAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChmb2xkZXJUcmVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJvb3RGb2xkZXJzLnB1c2goZm9sZGVyVHJlZSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICByZXR1cm4gcm9vdEZvbGRlcnM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGb2xkZXJUcmVlUGFnaW5hdGVkKHBhZ2UgPSAxLCBsaW1pdCA9IDEwMCk6IFByb21pc2U8eyBmb2xkZXJzOiBGb2xkZXJUcmVlW10sIHRvdGFsOiBudW1iZXIgfT4ge1xuICAgIGNvbnN0IG9mZnNldCA9IChwYWdlIC0gMSkgKiBsaW1pdDtcbiAgICBcbiAgICAvLyDsoITssrQg6rCc7IiYIOyhsO2ajFxuICAgIGNvbnN0IGNvdW50UmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoJ1NFTEVDVCBDT1VOVCgqKSBhcyB0b3RhbCBGUk9NIGZvbGRlcnMnKTtcbiAgICBjb25zdCB0b3RhbCA9IHBhcnNlSW50KGNvdW50UmVzdWx0LnJvd3NbMF0udG90YWwpO1xuICAgIFxuICAgIC8vIO2OmOydtOynleuQnCDtj7TrjZQg7KGw7ZqMXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgICdTRUxFQ1QgKiBGUk9NIGZvbGRlcnMgT1JERVIgQlkgbmFtZSBMSU1JVCAkMSBPRkZTRVQgJDInLFxuICAgICAgICBbbGltaXQsIG9mZnNldF1cbiAgICApO1xuICAgIFxuICAgIGNvbnN0IGZvbGRlcnMgPSByZXN1bHQucm93cy5tYXAocm93ID0+ICh7XG4gICAgICAgIC4uLnJvdyxcbiAgICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgICB0ZXN0Q2FzZUNvdW50OiAwXG4gICAgfSkpO1xuICAgIFxuICAgIHJldHVybiB7IGZvbGRlcnMsIHRvdGFsIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGb2xkZXJUcmVlV2l0aExhenlMb2FkaW5nKHBhcmVudElkPzogbnVtYmVyKTogUHJvbWlzZTxGb2xkZXJUcmVlW10+IHtcbiAgICBjb25zdCB3aGVyZUNsYXVzZSA9IHBhcmVudElkID8gJ1dIRVJFIHBhcmVudF9pZCA9ICQxJyA6ICdXSEVSRSBwYXJlbnRfaWQgSVMgTlVMTCc7XG4gICAgY29uc3QgcGFyYW1zID0gcGFyZW50SWQgPyBbcGFyZW50SWRdIDogW107XG4gICAgXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgIGBTRUxFQ1QgKiBGUk9NIGZvbGRlcnMgJHt3aGVyZUNsYXVzZX0gT1JERVIgQlkgbmFtZWAsXG4gICAgICAgIHBhcmFtc1xuICAgICk7XG4gICAgXG4gICAgcmV0dXJuIHJlc3VsdC5yb3dzLm1hcChyb3cgPT4gKHtcbiAgICAgICAgLi4ucm93LFxuICAgICAgICBjaGlsZHJlbjogW10sXG4gICAgICAgIHRlc3RDYXNlQ291bnQ6IDBcbiAgICB9KSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVGb2xkZXIoaWQ6IG51bWJlciwgdXBkYXRlczogUGFydGlhbDxGb2xkZXI+KTogUHJvbWlzZTxGb2xkZXIgfCBudWxsPiB7XG4gICAgY29uc3QgZmllbGRzID0gW107XG4gICAgY29uc3QgdmFsdWVzID0gW107XG4gICAgbGV0IHBhcmFtSW5kZXggPSAxO1xuICAgIFxuICAgIGlmICh1cGRhdGVzLm5hbWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBmaWVsZHMucHVzaChgbmFtZSA9ICQke3BhcmFtSW5kZXgrK31gKTtcbiAgICAgICAgdmFsdWVzLnB1c2godXBkYXRlcy5uYW1lKTtcbiAgICB9XG4gICAgaWYgKHVwZGF0ZXMuZGVzY3JpcHRpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBmaWVsZHMucHVzaChgZGVzY3JpcHRpb24gPSAkJHtwYXJhbUluZGV4Kyt9YCk7XG4gICAgICAgIHZhbHVlcy5wdXNoKHVwZGF0ZXMuZGVzY3JpcHRpb24pO1xuICAgIH1cbiAgICBpZiAodXBkYXRlcy5wYXJlbnRJZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGZpZWxkcy5wdXNoKGBwYXJlbnRfaWQgPSAkJHtwYXJhbUluZGV4Kyt9YCk7XG4gICAgICAgIHZhbHVlcy5wdXNoKHVwZGF0ZXMucGFyZW50SWQpO1xuICAgIH1cbiAgICBcbiAgICBmaWVsZHMucHVzaChgdXBkYXRlZF9hdCA9IENVUlJFTlRfVElNRVNUQU1QYCk7XG4gICAgdmFsdWVzLnB1c2goaWQpO1xuICAgIFxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KFxuICAgICAgICBgVVBEQVRFIGZvbGRlcnMgU0VUICR7ZmllbGRzLmpvaW4oJywgJyl9IFdIRVJFIGlkID0gJCR7cGFyYW1JbmRleH0gUkVUVVJOSU5HICpgLFxuICAgICAgICB2YWx1ZXNcbiAgICApO1xuICAgIFxuICAgIHJldHVybiByZXN1bHQucm93c1swXSB8fCBudWxsO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlRm9sZGVyKGlkOiBudW1iZXIpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnREVMRVRFIEZST00gZm9sZGVycyBXSEVSRSBpZCA9ICQxJywgW2lkXSk7XG4gICAgcmV0dXJuIChyZXN1bHQucm93Q291bnQgPz8gMCkgPiAwO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0VGVzdENhc2VzSW5Gb2xkZXIoZm9sZGVySWQ6IG51bWJlcik6IFByb21pc2U8bnVtYmVyW10+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgJ1NFTEVDVCB0ZXN0Y2FzZV9pZCBGUk9NIGNhc2VfZm9sZGVycyBXSEVSRSBmb2xkZXJfaWQgPSAkMScsXG4gICAgICAgIFtmb2xkZXJJZF1cbiAgICApO1xuICAgIHJldHVybiByZXN1bHQucm93cy5tYXAocm93ID0+IHJvdy50ZXN0Y2FzZV9pZCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZGRUZXN0Q2FzZVRvRm9sZGVyKHRlc3RDYXNlSWQ6IG51bWJlciwgZm9sZGVySWQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KFxuICAgICAgICAnSU5TRVJUIElOVE8gY2FzZV9mb2xkZXJzICh0ZXN0Y2FzZV9pZCwgZm9sZGVyX2lkKSBWQUxVRVMgKCQxLCAkMikgT04gQ09ORkxJQ1QgRE8gTk9USElORyBSRVRVUk5JTkcgaWQnLFxuICAgICAgICBbdGVzdENhc2VJZCwgZm9sZGVySWRdXG4gICAgKTtcbiAgICBpZiAocmVzdWx0LnJvd0NvdW50ID09PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcign7J2066+4IO2VtOuLuSDtj7TrjZTsl5Ag7Y+s7ZWo65CcIO2FjOyKpO2KuOy8gOydtOyKpOyeheuLiOuLpC4nKTtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW1vdmVUZXN0Q2FzZUZyb21Gb2xkZXIodGVzdENhc2VJZDogbnVtYmVyLCBmb2xkZXJJZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgICdERUxFVEUgRlJPTSBjYXNlX2ZvbGRlcnMgV0hFUkUgdGVzdGNhc2VfaWQgPSAkMSBBTkQgZm9sZGVyX2lkID0gJDInLFxuICAgICAgICBbdGVzdENhc2VJZCwgZm9sZGVySWRdXG4gICAgKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1vdmVUZXN0Q2FzZSh0ZXN0Q2FzZUlkOiBudW1iZXIsIGZyb21Gb2xkZXJJZDogbnVtYmVyLCB0b0ZvbGRlcklkOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeSgnQkVHSU4nKTtcbiAgICB0cnkge1xuICAgICAgICBhd2FpdCByZW1vdmVUZXN0Q2FzZUZyb21Gb2xkZXIodGVzdENhc2VJZCwgZnJvbUZvbGRlcklkKTtcbiAgICAgICAgYXdhaXQgYWRkVGVzdENhc2VUb0ZvbGRlcih0ZXN0Q2FzZUlkLCB0b0ZvbGRlcklkKTtcbiAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0NPTU1JVCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdST0xMQkFDSycpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtb3ZlVGVzdENhc2VzQmF0Y2godGVzdENhc2VJZHM6IG51bWJlcltdLCBmcm9tRm9sZGVySWQ6IG51bWJlciwgdG9Gb2xkZXJJZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0JFR0lOJyk7XG4gICAgdHJ5IHtcbiAgICAgICAgLy8g6riw7KG0IOq0gOqzhCDsoJzqsbBcbiAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoXG4gICAgICAgICAgICAnREVMRVRFIEZST00gY2FzZV9mb2xkZXJzIFdIRVJFIHRlc3RjYXNlX2lkID0gQU5ZKCQxKSBBTkQgZm9sZGVyX2lkID0gJDInLFxuICAgICAgICAgICAgW3Rlc3RDYXNlSWRzLCBmcm9tRm9sZGVySWRdXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgICAvLyDsg4gg6rSA6rOEIOy2lOqwgCAo67Cw7LmYIOyymOumrClcbiAgICAgICAgY29uc3QgdmFsdWVzID0gdGVzdENhc2VJZHMubWFwKChfLCBpbmRleCkgPT4gYCgkJHtpbmRleCArIDF9LCAkJHt0ZXN0Q2FzZUlkcy5sZW5ndGggKyAxfSlgKS5qb2luKCcsICcpO1xuICAgICAgICBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgICAgIGBJTlNFUlQgSU5UTyBjYXNlX2ZvbGRlcnMgKHRlc3RjYXNlX2lkLCBmb2xkZXJfaWQpIFZBTFVFUyAke3ZhbHVlc31gLFxuICAgICAgICAgICAgWy4uLnRlc3RDYXNlSWRzLCB0b0ZvbGRlcklkXVxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgcGdDbGllbnQucXVlcnkoJ0NPTU1JVCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGF3YWl0IHBnQ2xpZW50LnF1ZXJ5KCdST0xMQkFDSycpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGVja0NpcmN1bGFyUmVmZXJlbmNlKGZvbGRlcklkOiBudW1iZXIsIG5ld1BhcmVudElkOiBudW1iZXIpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAoIW5ld1BhcmVudElkKSByZXR1cm4gZmFsc2U7XG4gICAgXG4gICAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGxldCBjdXJyZW50SWQgPSBuZXdQYXJlbnRJZDtcbiAgICBcbiAgICB3aGlsZSAoY3VycmVudElkKSB7XG4gICAgICAgIGlmICh2aXNpdGVkLmhhcyhjdXJyZW50SWQpIHx8IGN1cnJlbnRJZCA9PT0gZm9sZGVySWQpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyDsiJztmZgg7LC47KGwIOuwnOqyrFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB2aXNpdGVkLmFkZChjdXJyZW50SWQpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwZ0NsaWVudC5xdWVyeShcbiAgICAgICAgICAgICdTRUxFQ1QgcGFyZW50X2lkIEZST00gZm9sZGVycyBXSEVSRSBpZCA9ICQxJyxcbiAgICAgICAgICAgIFtjdXJyZW50SWRdXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgICBpZiAocmVzdWx0LnJvd3MubGVuZ3RoID09PSAwKSBicmVhaztcbiAgICAgICAgY3VycmVudElkID0gcmVzdWx0LnJvd3NbMF0ucGFyZW50X2lkO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gZmFsc2U7XG59ICJdLCJ2ZXJzaW9uIjozfQ==