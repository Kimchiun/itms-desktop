13cbf7b9875aae628cdf2f427f6a7d46
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// 모킹 설정 - 올바른 경로 사용
jest.mock('../src/main/app/infrastructure/database/pgClient', () => ({
    query: jest.fn().mockResolvedValue({ rows: [] }),
    connect: jest.fn().mockResolvedValue({}),
}));
jest.mock('../src/main/app/infrastructure/elasticsearch/esClient', () => ({
    search: jest.fn().mockResolvedValue({ hits: { hits: [] } }),
    index: jest.fn().mockResolvedValue({}),
}));
const util_1 = require("util");
global.TextEncoder = util_1.TextEncoder;
global.TextDecoder = util_1.TextDecoder;
// ClearImmediate 폴리필 추가
if (typeof global.clearImmediate === 'undefined') {
    global.clearImmediate = jest.fn();
}
if (typeof global.ReadableStream === 'undefined') {
    global.ReadableStream = require('stream').Readable;
}
if (typeof global.setImmediate === 'undefined') {
    global.setImmediate = (fn, ...args) => setTimeout(fn, 0, ...args);
}
if (typeof global.Response === 'undefined') {
    global.Response = class {
    };
}
if (typeof global.TransformStream === 'undefined') {
    global.TransformStream = class {
    };
}
if (typeof global.Request === 'undefined') {
    global.Request = class {
    };
}
const supertest_1 = __importDefault(require("supertest"));
const app_1 = __importDefault(require("../src/main/app/app"));
const nock_1 = __importDefault(require("nock"));
// MSW와의 충돌 방지를 위한 설정
beforeAll(() => {
    // nock이 모든 HTTP 요청을 가로채도록 설정
    nock_1.default.disableNetConnect();
    nock_1.default.enableNetConnect('127.0.0.1');
    nock_1.default.enableNetConnect('localhost');
});
afterAll(() => {
    nock_1.default.restore();
});
describe('Jira Integration API', () => {
    const JIRA_URL = 'http://mock-jira.local';
    const API_PATH = '/rest/api/2/issue';
    const TEST_EXECUTION_ID = 1;
    const TEST_PARAMS = {
        executionId: TEST_EXECUTION_ID,
        summary: 'Test bug summary',
        description: 'Bug description',
        projectKey: 'TEST',
        jiraUrl: JIRA_URL,
        username: 'user',
        apiToken: 'token',
    };
    beforeEach(() => {
        // 각 테스트 전에 nock 초기화
        nock_1.default.cleanAll();
        jest.clearAllMocks();
    });
    afterEach(() => {
        nock_1.default.cleanAll();
    });
    it('should create a Jira issue and update execution', async () => {
        (0, nock_1.default)(JIRA_URL)
            .post(API_PATH)
            .reply(201, { key: 'TEST-123' });
        const res = await (0, supertest_1.default)(app_1.default)
            .post('/api/integrations/jira-issue')
            .send(TEST_PARAMS);
        expect(res.status).toBe(200);
        expect(res.body.key).toBe('TEST-123');
        expect(res.body.url).toContain('TEST-123');
    }, 60000);
    it('should handle Jira API error', async () => {
        (0, nock_1.default)(JIRA_URL)
            .post(API_PATH)
            .reply(400, { errorMessages: ['Invalid project'] });
        const res = await (0, supertest_1.default)(app_1.default)
            .post('/api/integrations/jira-issue')
            .send(TEST_PARAMS);
        expect(res.status).toBe(500);
        expect(res.body.error).toMatch(/Invalid project/);
    }, 60000);
    it('should handle Jira API timeout', async () => {
        (0, nock_1.default)(JIRA_URL)
            .post(API_PATH)
            .delay(9000)
            .reply(201, { key: 'TEST-999' });
        const res = await (0, supertest_1.default)(app_1.default)
            .post('/api/integrations/jira-issue')
            .send({ ...TEST_PARAMS, timeoutMs: 1000 });
        expect(res.status).toBe(500);
        expect(res.body.error).toMatch(/timed out/);
    }, 60000);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC90ZXN0cy9pbnRlZ3JhdGlvbi5qaXJhLmFwaS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBNkJBLG9CQUFvQjtBQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbkUsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQztJQUNoRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztDQUN6QyxDQUFDLENBQUMsQ0FBQztBQUVKLElBQUksQ0FBQyxJQUFJLENBQUMsdURBQXVELEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN4RSxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDM0QsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7Q0FDdkMsQ0FBQyxDQUFDLENBQUM7QUF0Q0osK0JBQWdEO0FBQy9DLE1BQWMsQ0FBQyxXQUFXLEdBQUcsa0JBQVcsQ0FBQztBQUN6QyxNQUFjLENBQUMsV0FBVyxHQUFHLGtCQUFXLENBQUM7QUFFMUMsd0JBQXdCO0FBQ3hCLElBQUksT0FBUSxNQUFjLENBQUMsY0FBYyxLQUFLLFdBQVcsRUFBRSxDQUFDO0lBQ3pELE1BQWMsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQzdDLENBQUM7QUFFRCxJQUFJLE9BQVEsTUFBYyxDQUFDLGNBQWMsS0FBSyxXQUFXLEVBQUUsQ0FBQztJQUN6RCxNQUFjLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxR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Q0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2hELENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNkLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy8zaS1hMS0yMDIxLTAxNy9EZXNrdG9wL215LXByb2plY3QvdGVzdHMvaW50ZWdyYXRpb24uamlyYS5hcGkudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0RW5jb2RlciwgVGV4dERlY29kZXIgfSBmcm9tICd1dGlsJztcbihnbG9iYWwgYXMgYW55KS5UZXh0RW5jb2RlciA9IFRleHRFbmNvZGVyO1xuKGdsb2JhbCBhcyBhbnkpLlRleHREZWNvZGVyID0gVGV4dERlY29kZXI7XG5cbi8vIENsZWFySW1tZWRpYXRlIO2PtOumrO2VhCDstpTqsIBcbmlmICh0eXBlb2YgKGdsb2JhbCBhcyBhbnkpLmNsZWFySW1tZWRpYXRlID09PSAndW5kZWZpbmVkJykge1xuICAoZ2xvYmFsIGFzIGFueSkuY2xlYXJJbW1lZGlhdGUgPSBqZXN0LmZuKCk7XG59XG5cbmlmICh0eXBlb2YgKGdsb2JhbCBhcyBhbnkpLlJlYWRhYmxlU3RyZWFtID09PSAndW5kZWZpbmVkJykge1xuICAoZ2xvYmFsIGFzIGFueSkuUmVhZGFibGVTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKS5SZWFkYWJsZTtcbn1cbmlmICh0eXBlb2YgKGdsb2JhbCBhcyBhbnkpLnNldEltbWVkaWF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgKGdsb2JhbCBhcyBhbnkpLnNldEltbWVkaWF0ZSA9IChmbjogYW55LCAuLi5hcmdzOiBhbnlbXSkgPT4gc2V0VGltZW91dChmbiwgMCwgLi4uYXJncyk7XG59XG5pZiAodHlwZW9mIChnbG9iYWwgYXMgYW55KS5SZXNwb25zZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgKGdsb2JhbCBhcyBhbnkpLlJlc3BvbnNlID0gY2xhc3Mge307XG59XG5pZiAodHlwZW9mIChnbG9iYWwgYXMgYW55KS5UcmFuc2Zvcm1TdHJlYW0gPT09ICd1bmRlZmluZWQnKSB7XG4gIChnbG9iYWwgYXMgYW55KS5UcmFuc2Zvcm1TdHJlYW0gPSBjbGFzcyB7fTtcbn1cbmlmICh0eXBlb2YgKGdsb2JhbCBhcyBhbnkpLlJlcXVlc3QgPT09ICd1bmRlZmluZWQnKSB7XG4gIChnbG9iYWwgYXMgYW55KS5SZXF1ZXN0ID0gY2xhc3Mge307XG59XG5cbmltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XG5pbXBvcnQgYXBwIGZyb20gJy4uL3NyYy9tYWluL2FwcC9hcHAnO1xuaW1wb3J0IG5vY2sgZnJvbSAnbm9jayc7XG5cbi8vIOuqqO2CuSDshKTsoJUgLSDsmKzrsJTrpbgg6rK966GcIOyCrOyaqVxuamVzdC5tb2NrKCcuLi9zcmMvbWFpbi9hcHAvaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvcGdDbGllbnQnLCAoKSA9PiAoe1xuICBxdWVyeTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgcm93czogW10gfSksXG4gIGNvbm5lY3Q6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG59KSk7XG5cbmplc3QubW9jaygnLi4vc3JjL21haW4vYXBwL2luZnJhc3RydWN0dXJlL2VsYXN0aWNzZWFyY2gvZXNDbGllbnQnLCAoKSA9PiAoe1xuICBzZWFyY2g6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGhpdHM6IHsgaGl0czogW10gfSB9KSxcbiAgaW5kZXg6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG59KSk7XG5cbi8vIE1TV+yZgOydmCDstqnrj4wg67Cp7KeA66W8IOychO2VnCDshKTsoJVcbmJlZm9yZUFsbCgoKSA9PiB7XG4gIC8vIG5vY2vsnbQg66qo65OgIEhUVFAg7JqU7LKt7J2EIOqwgOuhnOyxhOuPhOuhnSDshKTsoJVcbiAgbm9jay5kaXNhYmxlTmV0Q29ubmVjdCgpO1xuICBub2NrLmVuYWJsZU5ldENvbm5lY3QoJzEyNy4wLjAuMScpO1xuICBub2NrLmVuYWJsZU5ldENvbm5lY3QoJ2xvY2FsaG9zdCcpO1xufSk7XG5cbmFmdGVyQWxsKCgpID0+IHtcbiAgbm9jay5yZXN0b3JlKCk7XG59KTtcblxuZGVzY3JpYmUoJ0ppcmEgSW50ZWdyYXRpb24gQVBJJywgKCkgPT4ge1xuICAgIGNvbnN0IEpJUkFfVVJMID0gJ2h0dHA6Ly9tb2NrLWppcmEubG9jYWwnO1xuICAgIGNvbnN0IEFQSV9QQVRIID0gJy9yZXN0L2FwaS8yL2lzc3VlJztcbiAgICBjb25zdCBURVNUX0VYRUNVVElPTl9JRCA9IDE7XG4gICAgY29uc3QgVEVTVF9QQVJBTVMgPSB7XG4gICAgICAgIGV4ZWN1dGlvbklkOiBURVNUX0VYRUNVVElPTl9JRCxcbiAgICAgICAgc3VtbWFyeTogJ1Rlc3QgYnVnIHN1bW1hcnknLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0J1ZyBkZXNjcmlwdGlvbicsXG4gICAgICAgIHByb2plY3RLZXk6ICdURVNUJyxcbiAgICAgICAgamlyYVVybDogSklSQV9VUkwsXG4gICAgICAgIHVzZXJuYW1lOiAndXNlcicsXG4gICAgICAgIGFwaVRva2VuOiAndG9rZW4nLFxuICAgIH07XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgLy8g6rCBIO2FjOyKpO2KuCDsoITsl5Agbm9jayDstIjquLDtmZRcbiAgICAgICAgbm9jay5jbGVhbkFsbCgpO1xuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICB9KTtcblxuICAgIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgICAgIG5vY2suY2xlYW5BbGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgSmlyYSBpc3N1ZSBhbmQgdXBkYXRlIGV4ZWN1dGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgbm9jayhKSVJBX1VSTClcbiAgICAgICAgICAgIC5wb3N0KEFQSV9QQVRIKVxuICAgICAgICAgICAgLnJlcGx5KDIwMSwgeyBrZXk6ICdURVNULTEyMycgfSk7XG5cbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgICAgICAucG9zdCgnL2FwaS9pbnRlZ3JhdGlvbnMvamlyYS1pc3N1ZScpXG4gICAgICAgICAgICAuc2VuZChURVNUX1BBUkFNUyk7XG4gICAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICAgIGV4cGVjdChyZXMuYm9keS5rZXkpLnRvQmUoJ1RFU1QtMTIzJyk7XG4gICAgICAgIGV4cGVjdChyZXMuYm9keS51cmwpLnRvQ29udGFpbignVEVTVC0xMjMnKTtcbiAgICB9LCA2MDAwMCk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBKaXJhIEFQSSBlcnJvcicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgbm9jayhKSVJBX1VSTClcbiAgICAgICAgICAgIC5wb3N0KEFQSV9QQVRIKVxuICAgICAgICAgICAgLnJlcGx5KDQwMCwgeyBlcnJvck1lc3NhZ2VzOiBbJ0ludmFsaWQgcHJvamVjdCddIH0pO1xuXG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAgICAgLnBvc3QoJy9hcGkvaW50ZWdyYXRpb25zL2ppcmEtaXNzdWUnKVxuICAgICAgICAgICAgLnNlbmQoVEVTVF9QQVJBTVMpO1xuICAgICAgICBleHBlY3QocmVzLnN0YXR1cykudG9CZSg1MDApO1xuICAgICAgICBleHBlY3QocmVzLmJvZHkuZXJyb3IpLnRvTWF0Y2goL0ludmFsaWQgcHJvamVjdC8pO1xuICAgIH0sIDYwMDAwKTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIEppcmEgQVBJIHRpbWVvdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIG5vY2soSklSQV9VUkwpXG4gICAgICAgICAgICAucG9zdChBUElfUEFUSClcbiAgICAgICAgICAgIC5kZWxheSg5MDAwKVxuICAgICAgICAgICAgLnJlcGx5KDIwMSwgeyBrZXk6ICdURVNULTk5OScgfSk7XG5cbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgICAgICAucG9zdCgnL2FwaS9pbnRlZ3JhdGlvbnMvamlyYS1pc3N1ZScpXG4gICAgICAgICAgICAuc2VuZCh7IC4uLlRFU1RfUEFSQU1TLCB0aW1lb3V0TXM6IDEwMDAgfSk7XG4gICAgICAgIGV4cGVjdChyZXMuc3RhdHVzKS50b0JlKDUwMCk7XG4gICAgICAgIGV4cGVjdChyZXMuYm9keS5lcnJvcikudG9NYXRjaCgvdGltZWQgb3V0Lyk7XG4gICAgfSwgNjAwMDApO1xufSk7ICJdLCJ2ZXJzaW9uIjozfQ==