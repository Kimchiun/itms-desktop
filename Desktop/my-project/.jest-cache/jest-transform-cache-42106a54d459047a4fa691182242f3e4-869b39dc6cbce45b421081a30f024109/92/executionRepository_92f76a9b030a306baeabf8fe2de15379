b4f4697c20f6839990dbdfd483ab7f28
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.executionRepository = void 0;
const pgClient_1 = __importDefault(require("../../../infrastructure/database/pgClient"));
const pool = pgClient_1.default;
exports.executionRepository = {
    async insert(execution) {
        const now = new Date();
        const result = await pool.query(`INSERT INTO executions 
                (testcase_id, suite_id, release_id, status, executed_by, executed_at, repro_steps, screenshot_path, log_file_path, comment, created_at, updated_at)
             VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12)
             RETURNING *`, [
            execution.testcaseId,
            execution.suiteId ?? null,
            execution.releaseId ?? null,
            execution.status,
            execution.executedBy,
            execution.executedAt,
            execution.reproSteps ?? null,
            execution.screenshotPath ?? null,
            execution.logFilePath ?? null,
            execution.comment ?? null,
            now,
            now
        ]);
        return mapRowToExecution(result.rows[0]);
    },
    async findById(id) {
        const result = await pool.query('SELECT * FROM executions WHERE id = $1', [id]);
        return result.rows[0] ? mapRowToExecution(result.rows[0]) : null;
    },
    async findByTestCase(testcaseId) {
        const result = await pool.query('SELECT * FROM executions WHERE testcase_id = $1', [testcaseId]);
        return result.rows.map(mapRowToExecution);
    },
    async update(id, update) {
        // 동적 쿼리 빌드(간단화)
        const fields = Object.keys(update);
        if (fields.length === 0)
            return this.findById(id);
        const setClause = fields.map((f, i) => `${toSnakeCase(f)} = $${i + 1}`).join(', ');
        const values = fields.map(f => update[f]);
        values.push(new Date()); // updated_at
        const result = await pool.query(`UPDATE executions SET ${setClause}, updated_at = $${fields.length + 1} WHERE id = $${fields.length + 2} RETURNING *`, [...values, id]);
        return result.rows[0] ? mapRowToExecution(result.rows[0]) : null;
    },
    async delete(id) {
        await pool.query('DELETE FROM executions WHERE id = $1', [id]);
    }
};
function mapRowToExecution(row) {
    return {
        id: row.id,
        testcaseId: row.testcase_id,
        suiteId: row.suite_id,
        releaseId: row.release_id,
        status: row.status,
        executedBy: row.executed_by,
        executedAt: row.executed_at,
        reproSteps: row.repro_steps,
        screenshotPath: row.screenshot_path,
        logFilePath: row.log_file_path,
        comment: row.comment,
        createdAt: row.created_at,
        updatedAt: row.updated_at
    };
}
function toSnakeCase(str) {
    return str.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy9leGVjdXRpb25zL3JlcG9zaXRvcmllcy9leGVjdXRpb25SZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLHlGQUF3RjtBQUV4RixNQUFNLElBQUksR0FBRyxrQkFBUSxDQUFDO0FBRVQsUUFBQSxtQkFBbUIsR0FBRztJQUMvQixLQUFLLENBQUMsTUFBTSxDQUFDLFNBQTREO1FBQ3JFLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUMzQjs7O3lCQUdhLEVBQ2I7WUFDSSxTQUFTLENBQUMsVUFBVTtZQUNwQixTQUFTLENBQUMsT0FBTyxJQUFJLElBQUk7WUFDekIsU0FBUyxDQUFDLFNBQVMsSUFBSSxJQUFJO1lBQzNCLFNBQVMsQ0FBQyxNQUFNO1lBQ2hCLFNBQVMsQ0FBQyxVQUFVO1lBQ3BCLFNBQVMsQ0FBQyxVQUFVO1lBQ3BCLFNBQVMsQ0FBQyxVQUFVLElBQUksSUFBSTtZQUM1QixTQUFTLENBQUMsY0FBYyxJQUFJLElBQUk7WUFDaEMsU0FBUyxDQUFDLFdBQVcsSUFBSSxJQUFJO1lBQzdCLFNBQVMsQ0FBQyxPQUFPLElBQUksSUFBSTtZQUN6QixHQUFHO1lBQ0gsR0FBRztTQUNOLENBQ0osQ0FBQztRQUNGLE9BQU8saUJBQWlCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQVU7UUFDckIsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNoRixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLE1BQU0s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ZXMiOlsiL1VzZXJzLzNpLWExLTIwMjEtMDE3L0Rlc2t0b3AvbXktcHJvamVjdC9zcmMvbWFpbi9hcHAvZG9tYWlucy9leGVjdXRpb25zL3JlcG9zaXRvcmllcy9leGVjdXRpb25SZXBvc2l0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV4ZWN1dGlvbiB9IGZyb20gJy4uL21vZGVscy9FeGVjdXRpb24nO1xuaW1wb3J0IHBnQ2xpZW50LCB7IGVuc3VyZVBnQ29ubmVjdGVkIH0gZnJvbSAnLi4vLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvZGF0YWJhc2UvcGdDbGllbnQnO1xuXG5jb25zdCBwb29sID0gcGdDbGllbnQ7XG5cbmV4cG9ydCBjb25zdCBleGVjdXRpb25SZXBvc2l0b3J5ID0ge1xuICAgIGFzeW5jIGluc2VydChleGVjdXRpb246IE9taXQ8RXhlY3V0aW9uLCAnaWQnIHwgJ2NyZWF0ZWRBdCcgfCAndXBkYXRlZEF0Jz4pOiBQcm9taXNlPEV4ZWN1dGlvbj4ge1xuICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwb29sLnF1ZXJ5KFxuICAgICAgICAgICAgYElOU0VSVCBJTlRPIGV4ZWN1dGlvbnMgXG4gICAgICAgICAgICAgICAgKHRlc3RjYXNlX2lkLCBzdWl0ZV9pZCwgcmVsZWFzZV9pZCwgc3RhdHVzLCBleGVjdXRlZF9ieSwgZXhlY3V0ZWRfYXQsIHJlcHJvX3N0ZXBzLCBzY3JlZW5zaG90X3BhdGgsIGxvZ19maWxlX3BhdGgsIGNvbW1lbnQsIGNyZWF0ZWRfYXQsIHVwZGF0ZWRfYXQpXG4gICAgICAgICAgICAgVkFMVUVTICgkMSwkMiwkMywkNCwkNSwkNiwkNywkOCwkOSwkMTAsJDExLCQxMilcbiAgICAgICAgICAgICBSRVRVUk5JTkcgKmAsXG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgZXhlY3V0aW9uLnRlc3RjYXNlSWQsXG4gICAgICAgICAgICAgICAgZXhlY3V0aW9uLnN1aXRlSWQgPz8gbnVsbCxcbiAgICAgICAgICAgICAgICBleGVjdXRpb24ucmVsZWFzZUlkID8/IG51bGwsXG4gICAgICAgICAgICAgICAgZXhlY3V0aW9uLnN0YXR1cyxcbiAgICAgICAgICAgICAgICBleGVjdXRpb24uZXhlY3V0ZWRCeSxcbiAgICAgICAgICAgICAgICBleGVjdXRpb24uZXhlY3V0ZWRBdCxcbiAgICAgICAgICAgICAgICBleGVjdXRpb24ucmVwcm9TdGVwcyA/PyBudWxsLFxuICAgICAgICAgICAgICAgIGV4ZWN1dGlvbi5zY3JlZW5zaG90UGF0aCA/PyBudWxsLFxuICAgICAgICAgICAgICAgIGV4ZWN1dGlvbi5sb2dGaWxlUGF0aCA/PyBudWxsLFxuICAgICAgICAgICAgICAgIGV4ZWN1dGlvbi5jb21tZW50ID8/IG51bGwsXG4gICAgICAgICAgICAgICAgbm93LFxuICAgICAgICAgICAgICAgIG5vd1xuICAgICAgICAgICAgXVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gbWFwUm93VG9FeGVjdXRpb24ocmVzdWx0LnJvd3NbMF0pO1xuICAgIH0sXG5cbiAgICBhc3luYyBmaW5kQnlJZChpZDogbnVtYmVyKTogUHJvbWlzZTxFeGVjdXRpb24gfCBudWxsPiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBvb2wucXVlcnkoJ1NFTEVDVCAqIEZST00gZXhlY3V0aW9ucyBXSEVSRSBpZCA9ICQxJywgW2lkXSk7XG4gICAgICAgIHJldHVybiByZXN1bHQucm93c1swXSA/IG1hcFJvd1RvRXhlY3V0aW9uKHJlc3VsdC5yb3dzWzBdKSA6IG51bGw7XG4gICAgfSxcblxuICAgIGFzeW5jIGZpbmRCeVRlc3RDYXNlKHRlc3RjYXNlSWQ6IG51bWJlcik6IFByb21pc2U8RXhlY3V0aW9uW10+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcG9vbC5xdWVyeSgnU0VMRUNUICogRlJPTSBleGVjdXRpb25zIFdIRVJFIHRlc3RjYXNlX2lkID0gJDEnLCBbdGVzdGNhc2VJZF0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0LnJvd3MubWFwKG1hcFJvd1RvRXhlY3V0aW9uKTtcbiAgICB9LFxuXG4gICAgYXN5bmMgdXBkYXRlKGlkOiBudW1iZXIsIHVwZGF0ZTogUGFydGlhbDxPbWl0PEV4ZWN1dGlvbiwgJ2lkJyB8ICdjcmVhdGVkQXQnPj4pOiBQcm9taXNlPEV4ZWN1dGlvbiB8IG51bGw+IHtcbiAgICAgICAgLy8g64+Z7KCBIOy/vOumrCDruYzrk5wo6rCE64uo7ZmUKVxuICAgICAgICBjb25zdCBmaWVsZHMgPSBPYmplY3Qua2V5cyh1cGRhdGUpO1xuICAgICAgICBpZiAoZmllbGRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRoaXMuZmluZEJ5SWQoaWQpO1xuICAgICAgICBjb25zdCBzZXRDbGF1c2UgPSBmaWVsZHMubWFwKChmLCBpKSA9PiBgJHt0b1NuYWtlQ2FzZShmKX0gPSAkJHtpICsgMX1gKS5qb2luKCcsICcpO1xuICAgICAgICBjb25zdCB2YWx1ZXMgPSBmaWVsZHMubWFwKGYgPT4gKHVwZGF0ZSBhcyBhbnkpW2ZdKTtcbiAgICAgICAgdmFsdWVzLnB1c2gobmV3IERhdGUoKSk7IC8vIHVwZGF0ZWRfYXRcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcG9vbC5xdWVyeShcbiAgICAgICAgICAgIGBVUERBVEUgZXhlY3V0aW9ucyBTRVQgJHtzZXRDbGF1c2V9LCB1cGRhdGVkX2F0ID0gJCR7ZmllbGRzLmxlbmd0aCArIDF9IFdIRVJFIGlkID0gJCR7ZmllbGRzLmxlbmd0aCArIDJ9IFJFVFVSTklORyAqYCxcbiAgICAgICAgICAgIFsuLi52YWx1ZXMsIGlkXVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gcmVzdWx0LnJvd3NbMF0gPyBtYXBSb3dUb0V4ZWN1dGlvbihyZXN1bHQucm93c1swXSkgOiBudWxsO1xuICAgIH0sXG5cbiAgICBhc3luYyBkZWxldGUoaWQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCBwb29sLnF1ZXJ5KCdERUxFVEUgRlJPTSBleGVjdXRpb25zIFdIRVJFIGlkID0gJDEnLCBbaWRdKTtcbiAgICB9XG59O1xuXG5mdW5jdGlvbiBtYXBSb3dUb0V4ZWN1dGlvbihyb3c6IGFueSk6IEV4ZWN1dGlvbiB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IHJvdy5pZCxcbiAgICAgICAgdGVzdGNhc2VJZDogcm93LnRlc3RjYXNlX2lkLFxuICAgICAgICBzdWl0ZUlkOiByb3cuc3VpdGVfaWQsXG4gICAgICAgIHJlbGVhc2VJZDogcm93LnJlbGVhc2VfaWQsXG4gICAgICAgIHN0YXR1czogcm93LnN0YXR1cyxcbiAgICAgICAgZXhlY3V0ZWRCeTogcm93LmV4ZWN1dGVkX2J5LFxuICAgICAgICBleGVjdXRlZEF0OiByb3cuZXhlY3V0ZWRfYXQsXG4gICAgICAgIHJlcHJvU3RlcHM6IHJvdy5yZXByb19zdGVwcyxcbiAgICAgICAgc2NyZWVuc2hvdFBhdGg6IHJvdy5zY3JlZW5zaG90X3BhdGgsXG4gICAgICAgIGxvZ0ZpbGVQYXRoOiByb3cubG9nX2ZpbGVfcGF0aCxcbiAgICAgICAgY29tbWVudDogcm93LmNvbW1lbnQsXG4gICAgICAgIGNyZWF0ZWRBdDogcm93LmNyZWF0ZWRfYXQsXG4gICAgICAgIHVwZGF0ZWRBdDogcm93LnVwZGF0ZWRfYXRcbiAgICB9O1xufVxuXG5mdW5jdGlvbiB0b1NuYWtlQ2FzZShzdHI6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bQS1aXS9nLCBsZXR0ZXIgPT4gYF8ke2xldHRlci50b0xvd2VyQ2FzZSgpfWApO1xufSAiXSwidmVyc2lvbiI6M30=